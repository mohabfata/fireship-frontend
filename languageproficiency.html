<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Language Proficiency | Fireship English</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- STYLES (Keep Existing Styles from languageproficiency.html first) --- */
        :root {
             /* Use languageproficiency.html variables for consistency on this page */
            --primary-color: #5A8DEE;
            --secondary-color: #3DDC97;
            --dark-purple: #4B0082; /* Used by header notification dot if needed */
            --accent-color: #FF6347; /* Used by feedback/quiz */
            --success-color: #28a745;
            --warning-color: #ffc107;
            --light-color: #ffffff;
            --bg-light: #f8faff; /* Used by profile dropdown */
            --bg-section-alt: #f5f8fd;
            --dark-color: #34495e; /* Used by header text */
            --gray-color: #8492a6; /* Used by header icons */
            --border-color: #eef2f7; /* Used by header border, dropdown border */
            --input-bg-color: #f7faff;
            --border-radius: 16px; /* Main content uses 16px */
            --box-shadow: 0 22px 55px rgba(90, 141, 238, 0.18);
            --box-shadow-light: 0 10px 30px rgba(0, 0, 0, 0.06);
            --transition-speed: 0.3s;
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --animation-speed: 0.5s;
            --danger-color: #f72585; /* Added from profile header */
        }
        /* --- Base Styles (Keep from languageproficiency.html) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; scroll-padding-top: 70px; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-light); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23eaf2ff' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v1 S9 22.5 9 22.5h10v-1.5S23 15 23 15L12.99 7.5zM28 19.09v15l-14 8.08L0 34.09v-15L14 5.91 28 19.09z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); min-height: 100vh; color: var(--dark-color); line-height: 1.7; overflow-x: hidden; padding-top: 70px; padding-bottom: 60px; }

        /* --- Header Styles (Imported and adapted from Profile.html) --- */
        header.main-header {
            background-color: white; /* Solid white initially */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            padding: 0 2rem; /* Use profile padding */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between; /* Space between logo and profile */
            align-items: center;
            height: 70px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        body.scrolled header.main-header {
            background-color: rgba(255, 255, 255, 0.97); /* Slightly transparent on scroll */
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
            border-bottom: 1px solid var(--border-color);
        }
        .header-logo-link { /* Added from profile */
            display: flex;
            align-items: center;
            text-decoration: none;
            height: 100%;
        }
        .header-logo {
            display: flex;
            align-items: center;
            height: 40px;
            overflow: visible;
        }
        .header-logo img {
            height: 80px; /* Profile header uses 80px */
            margin-right: 0.8rem;
            transform: translateY(-7px); /* Profile header transform */
        }
        .header-logo span {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        /* User Profile Header (Copied from Profile.html) */
        .user-profile-header {
            display: none; /* Initially hidden, shown by JS if logged in */
            align-items: center;
            gap: 12px;
            position: relative;
            cursor: pointer;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            object-fit: cover;
            background-color: #eee;
        }
        .user-name-header {
            font-weight: 600;
            color: var(--dark-color);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .notification-dot {
            width: 10px;
            height: 10px;
            /* Use a distinct color like accent or dark purple if primary is used elsewhere */
            background-color: var(--dark-purple); /* Adjusted color */
            border-radius: 50%;
            position: absolute;
            top: 0;
            right: 0;
            border: 1.5px solid white;
            display: none; /* Shown by JS */
        }
        .profile-dropdown {
            display: none; /* Toggled by JS */
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: white;
            border-radius: 8px; /* Use profile border-radius */
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            z-index: 1010;
            min-width: 200px;
            overflow: hidden;
            list-style: none;
            padding: 8px 0;
        }
        .profile-dropdown a, .profile-dropdown button {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 10px 18px;
            color: var(--dark-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .profile-dropdown a:hover, .profile-dropdown button:hover {
            background-color: var(--bg-light); /* Use this page's variable */
            color: var(--primary-color);
        }
        .profile-dropdown a i, .profile-dropdown button i {
            margin-right: 12px;
            color: var(--gray-color); /* Use this page's variable */
            transition: color 0.2s ease;
            width: 16px;
            text-align: center;
        }
        .profile-dropdown a:hover i, .profile-dropdown button:hover i {
            color: var(--primary-color);
        }
        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 8px 0;
        }
        .lessons-link span { flex-grow: 1; }
        .lessons-link .notification-dot { /* Style for dot inside link */
            position: static;
            display: inline-block;
            margin-left: 8px;
            width: 8px;
            height: 8px;
            vertical-align: middle;
            background-color: var(--dark-purple); /* Match header dot */
            border-radius: 50%;
            border: 1px solid white;
            visibility: hidden; /* Toggled by JS */
        }
        .lessons-link .notification-dot.visible { visibility: visible; }
        #signInLink {
            display: none; /* Hidden by default, shown by JS if logged out */
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 18px;
            border: 2px solid var(--primary-color);
            border-radius: 50px;
            transition: all var(--transition-speed) var(--transition-timing);
        }
        #signInLink:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* --- REMOVE Original Simplified Header Styles ---
           We keep the body.scrolled one as it's compatible.
        --- */

        .page-container { max-width: 1000px; margin: 40px auto 0; padding: 0 20px; }
        /* Page Header (Keep Existing) */
        .page-header { text-align: center; margin-bottom: 40px; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s var(--transition-timing) forwards; } .page-header h1 { font-size: 2.8rem; color: var(--primary-color); margin-bottom: 10px; font-weight: 700; } .page-header p { font-size: 1.15rem; color: var(--gray-color); max-width: 700px; margin: 0 auto; }
        /* Native Language Section (Keep Existing) */
        .native-language-section { background-color: var(--light-color); padding: 25px 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-light); border: 1px solid var(--border-color); display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px 25px; margin-bottom: 50px; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s var(--transition-timing) 0.1s forwards; } .native-language-label { font-size: 1.1rem; font-weight: 600; color: var(--dark-color); margin-right: 15px; white-space: nowrap; } .native-language-options { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; } .language-option { display: flex; align-items: center; gap: 8px; padding: 8px 15px; border-radius: 50px; border: 1px solid var(--border-color); background-color: var(--bg-light); cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); } .language-option img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; } .language-option span { font-size: 0.95rem; font-weight: 500; color: var(--dark-color); } .language-option:hover { border-color: var(--secondary-color); background-color: var(--light-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); } .language-option.selected { border-color: var(--primary-color); background-color: rgba(90, 141, 238, 0.1); box-shadow: 0 3px 8px rgba(90, 141, 238, 0.15); } .language-option.selected span { font-weight: 600; color: var(--primary-color); }
        /* Proficiency Selection Section (Keep Existing) */
        .proficiency-section { background-color: var(--light-color); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid var(--border-color); margin-bottom: 40px; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s var(--transition-timing) 0.2s forwards; } .proficiency-header { text-align: center; margin-bottom: 35px; } .proficiency-header h2 { font-size: 2rem; color: var(--primary-color); margin: 0 0 8px 0; font-weight: 700; } .proficiency-header p { font-size: 1.1rem; color: var(--gray-color); margin: 0; }
        /* Horizontal Level Selector Container (Keep Existing) */
        .level-selector-container { overflow-x: auto; padding: 20px 0 25px 0; margin-bottom: 35px; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); background-color: var(--bg-section-alt); scrollbar-width: thin; scrollbar-color: var(--primary-color) var(--border-color); } .level-selector-container::-webkit-scrollbar { height: 8px; } .level-selector-container::-webkit-scrollbar-track { background: var(--border-color); border-radius: 4px; } .level-selector-container::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; border: 2px solid var(--border-color); } .level-selector-container::-webkit-scrollbar-thumb:hover { background-color: #4a7bd8; } .level-selector-items { display: flex; gap: 20px; width: max-content; padding: 0 15px; } .proficiency-level-item { flex-shrink: 0; width: 120px; padding: 18px 10px; border: 2px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--light-color); text-align: center; cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: var(--box-shadow-light); } .proficiency-level-item:hover { transform: translateY(-6px); box-shadow: 0 12px 25px rgba(0,0,0,0.08); border-color: rgba(90, 141, 238, 0.5); } .proficiency-level-item.selected { border-color: var(--primary-color); border-width: 3px; background-color: rgba(90, 141, 238, 0.05); box-shadow: 0 8px 25px rgba(90, 141, 238, 0.18); transform: translateY(-3px) scale(1.03); } .proficiency-level-item.selected::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 8px; right: 8px; font-size: 0.9rem; color: var(--light-color); background-color: var(--primary-color); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2); animation: popIn 0.3s ease-out forwards; } .level-image-container { width: 70px; height: 70px; margin-bottom: 12px; border-radius: 50%; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.1); background-color: var(--light-color); } .level-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; transition: opacity var(--transition-speed) ease; } .level-label { font-size: 1rem; font-weight: 600; color: var(--dark-color); margin-top: 8px; } .proficiency-level-item.selected .level-label { color: var(--primary-color); }
        /* Level Description Area (Keep Existing) */
        .level-description-area { background-color: transparent; border: none; border-radius: 0; padding: 10px 0 25px 0; margin-top: 0; min-height: 60px; transition: none; position: relative; text-align: center; } .level-description-area p { color: var(--dark-color); font-size: 1.1rem; line-height: 1.7; font-weight: 500; max-width: 600px; margin: 0 auto; opacity: 1; transition: opacity 0.3s ease-in-out; } .level-description-area p.placeholder { font-style: italic; opacity: 0.7; color: var(--gray-color); } .level-description-area p.fade-out { opacity: 0; } .level-description-area p.fade-in { opacity: 1; }
        /* Test Button Area (Keep Existing) */
        .test-button-area { text-align: center; margin-top: 15px; } .quick-test-button { padding: 10px 25px; font-size: 1rem; border: none; background: linear-gradient(90deg, var(--secondary-color), #30c9a3); color: white; border-radius: 50px; cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); box-shadow: 0 5px 15px rgba(61, 220, 151, 0.3); font-weight: 600; display: inline-flex; align-items: center; gap: 8px; } .quick-test-button i { font-size: 0.9em; } .quick-test-button:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px rgba(61, 220, 151, 0.4); filter: brightness(1.1); }
        /* Continue Button Area (Keep Existing) */
        .continue-button-container { text-align: center; margin-top: 50px; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s var(--transition-timing) 0.3s forwards; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 40px; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); text-decoration: none; background: linear-gradient(90deg, var(--primary-color), var(--dark-purple)); color: var(--light-color); box-shadow: 0 8px 25px rgba(90, 141, 238, 0.25); }
        .btn:hover:not(:disabled) { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(90, 141, 238, 0.35); filter: brightness(1.1); } .btn:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(90, 141, 238, 0.2); }
        .btn:disabled { background: linear-gradient(90deg, #bdc3c7, #95a5a6); color: #ecf0f1; cursor: not-allowed; box-shadow: none; filter: grayscale(80%); pointer-events: none; }
         /* Loading state for buttons (Keep Existing) */
         .btn .btn-text { display: inline; } .btn .btn-loader { display: none; } .btn .btn-icon { display: inline-block; margin-left: 5px; font-size: 0.9em; }
         .btn.loading .btn-text { display: none; } .btn.loading .btn-loader { display: inline-block; } .btn.loading .btn-icon { display: none; }
         /* Submission Feedback (Keep Existing) */
         #submissionFeedback { text-align: center; margin-top: 1.5rem; font-weight: 500; font-size: 0.95rem; display: none; }
         #submissionFeedback.success { color: var(--success-color); }
         #submissionFeedback.error { color: var(--accent-color); }
        /* Quiz Modal Styles (Keep Existing) */
        .quiz-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.8); display: none; align-items: center; justify-content: center; z-index: 1010; padding: 20px; backdrop-filter: blur(5px); } .quiz-content { position: relative; background: var(--light-color); padding: 40px 30px 30px; width: 100%; max-width: 650px; border-radius: var(--border-radius); box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow-y: auto; max-height: 90vh; border-top: 5px solid var(--primary-color); animation: fadeInScaleUp 0.4s var(--transition-timing) forwards; opacity: 0; transform: scale(0.95); } .quiz-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2rem; font-weight: 300; cursor: pointer; color: var(--gray-color); line-height: 1; transition: color var(--transition-speed), transform var(--transition-speed); } .quiz-close:hover { color: var(--dark-color); transform: rotate(90deg); } .quiz-timer { position: absolute; top: 22px; right: 60px; font-size: 1.4em; font-weight: 700; color: var(--primary-color); } .quiz-content h2 { text-align:center; color:var(--primary-color); margin-bottom: 25px; font-size: 1.8rem; } #quizQuestionContainer { margin-bottom: 30px; } .quiz-question p { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; line-height: 1.5; } .quiz-options label { font-size: 1.1em; margin-bottom: 12px; cursor: pointer; display: block; padding: 12px 18px; border-radius: 10px; border: 1px solid var(--border-color); transition: background-color var(--transition-speed), border-color var(--transition-speed); } .quiz-options label:hover { background-color: var(--bg-section-alt); border-color: #dce8fa; } .quiz-options input[type="radio"] { margin-right: 10px; accent-color: var(--primary-color); position: absolute; opacity: 0; } .quiz-options label span:first-child { font-weight: 700; margin-right: 8px; } .quiz-options input[type="radio"]:checked + label { background-color: rgba(90, 141, 238, 0.1); border-color: var(--primary-color); font-weight: 600; } .quiz-navigation { display: flex; justify-content: space-between; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 25px; } .quiz-navigation button { padding: 10px 25px; font-size: 1rem; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--light-color); border: none; border-radius: 50px; cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); box-shadow: 0 4px 12px rgba(90, 141, 238, 0.2); font-weight: 600; } .quiz-navigation button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 7px 18px rgba(90, 141, 238, 0.3); filter: brightness(1.1); } .quiz-navigation button#prevBtn { background: var(--light-color); color: var(--gray-color); border: 1px solid var(--border-color); box-shadow: none; } .quiz-navigation button#prevBtn:hover:not(:disabled) { background-color: var(--bg-section-alt); color: var(--dark-color); border-color: #dce8fa; box-shadow: none; filter: none;} .quiz-navigation button:disabled { background: #bdc3c7; color: #ecf0f1; cursor: not-allowed; box-shadow: none; filter: grayscale(80%); pointer-events: none;} .quiz-result { margin-top: 30px; font-size: 1.6em; font-weight: 700; text-align: center; color: var(--primary-color); } .final-message { text-align: center; font-size: 1.6em; font-weight: 700; color: var(--primary-color); } .final-message p { font-size: 1.1em; color: var(--dark-color); margin-bottom: 25px; font-weight: 500;} .final-message button { padding: 12px 30px; font-size: 1rem; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--light-color); border: none; border-radius: 50px; cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); box-shadow: 0 5px 15px rgba(90, 141, 238, 0.25); font-weight: 600; } .final-message button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(90, 141, 238, 0.35); filter: brightness(1.1); }
        /* Animations (Keep Existing) */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } } @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } } @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* Responsive Styles (Keep Existing, plus header adjustments) */
        @media (min-width: 992px) { .level-selector-container { overflow-x: visible; padding-left: 10px; padding-right: 10px; scrollbar-width: none; } .level-selector-container::-webkit-scrollbar { display: none; } .level-selector-items { flex-wrap: wrap; justify-content: center; width: auto; padding: 0 5px; gap: 15px 20px; } .proficiency-level-item { margin-bottom: 15px; flex-shrink: 1; } } @media (max-width: 991px) { .level-selector-container { overflow-x: auto; } .level-selector-items { flex-wrap: nowrap; width: max-content; justify-content: flex-start; } .proficiency-level-item { flex-shrink: 0; margin-bottom: 0; } }
        @media (max-width: 768px) {
             header.main-header{ padding: 0 1.5rem;} /* Adjust header padding */
             .page-header h1 { font-size: 2.4rem; } .proficiency-section { padding: 30px; } .proficiency-header h2 { font-size: 1.7rem; } .level-selector-container { padding-bottom: 15px;} .level-selector-items { gap: 15px; } .proficiency-level-item { width: 105px; } .level-image-container { width: 65px; height: 65px; } .level-label { font-size: 0.9rem; } .level-description-area { padding: 20px; min-height: 70px; } .level-description-area p { font-size: 1rem; } .quiz-content { padding: 30px 20px 20px; }
        }
        @media (max-width: 480px) {
             body { padding-top: 70px; } /* Ensure enough padding for slightly taller header */
             header.main-header { padding: 0 1rem; height: 70px; } /* Use consistent height */
             .user-name-header { display: none; } /* Hide name on small screens */
             .page-container { margin-top: 20px; } .page-header h1 { font-size: 2rem; } .page-header p { font-size: 1rem; } .native-language-label { margin-bottom: 15px; width: 100%; text-align: center;} .proficiency-header h2 { font-size: 1.5rem; } .level-selector-items { gap: 12px; } .proficiency-level-item { width: 95px; padding: 12px 8px;} .level-image-container { width: 60px; height: 60px; } .level-label { font-size: 0.85rem; } .level-description-area { padding: 15px; } .continue-button { width: 90%; max-width: 300px; padding: 12px; font-size: 1rem;} .quiz-timer { font-size: 1.2em; right: 15px; top: 18px;}
        }
    </style>
</head>
<body>
  <!-- Header (Imported from Profile.html) -->
  <header class="main-header">
    <a href="Index.html" class="header-logo-link"> <!-- Use link from profile -->
        <div class="header-logo">
            <img src="https://imgur.com/bXjTJAj.png" alt="Fireship Logo">
            <span>Fireship</span>
        </div>
    </a>
    <!-- Sign In Link (Shown/Hidden by JS) -->
    <a href="welcome.html?source=signIn" id="signInLink" style="display: none;">Sign In</a>
    <!-- User Profile Area (Shown/Hidden by JS) -->
    <div class="user-profile-header" id="user-profile-header">
         <span class="user-name-header" id="userNameHeader">User</span>
         <img src="placeholder-avatar.png" alt="User Avatar" class="user-avatar" id="userAvatarHeader">
         <div class="notification-dot" id="notificationDot"></div>
         <div class="profile-dropdown" id="profileDropdown">
             <a href="profile.html"><i class="fas fa-user-circle"></i> My Profile</a>
             <a href="lessons.html" class="lessons-link">
                 <i class="fas fa-calendar-check"></i>
                 <span>My Lessons</span>
                 <span class="notification-dot" id="lessonsNotificationDot"></span>
             </a>
             <div class="dropdown-divider"></div>
             <button id="signOutBtn"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
         </div>
    </div>
  </header>


  <div class="page-container">
    <header class="page-header"> <h1>Language Proficiency</h1> <p>Select your native language, then choose the English level that best fits you.</p> </header>
    <section class="native-language-section"> <div class="native-language-label">Your native language:</div> <div class="native-language-options" id="nativeLanguageOptions"> <div class="language-option selected" data-lang="arabic"> <img src="https://flagcdn.com/w40/sa.png" alt="Arabic"> <span>Arabic</span> </div> <div class="language-option" data-lang="german"> <img src="https://flagcdn.com/w40/de.png" alt="German"> <span>German</span> </div> <div class="language-option" data-lang="spanish"> <img src="https://flagcdn.com/w40/es.png" alt="Spanish"> <span>Spanish</span> </div> <div class="language-option" data-lang="french"> <img src="https://flagcdn.com/w40/fr.png" alt="French"> <span>French</span> </div> <div class="language-option" data-lang="chinese"> <img src="https://flagcdn.com/w40/cn.png" alt="Chinese"> <span>Chinese</span> </div> </div> </section>
    <section class="proficiency-section">
        <div class="proficiency-header"> <h2><i class="fas fa-layer-group" style="margin-right: 8px; color: var(--secondary-color);"></i> Select Your Level</h2> </div>
        <div class="level-selector-container"> <div class="level-selector-items" id="levelSelectorItems"> <!-- Generated by JS --> </div> </div>
        <div class="level-description-area" id="levelDescriptionArea"> <p class="placeholder">Select a level above to see its description.</p> </div>
        <div class="test-button-area"> <button class="quick-test-button" id="openQuiz"> <i class="fas fa-question-circle"></i> Not Sure? Take Quick Test </button> </div>
    </section>
     <!-- Submission Feedback Area -->
     <div id="submissionFeedback"></div>
    <div class="continue-button-container"> <button class="btn" id="continueButton" disabled> <span class="btn-text">Continue</span> <i class="fas fa-spinner fa-spin btn-loader" style="display: none;"></i> <i class="fas fa-arrow-right btn-icon"></i> </button> </div>
  </div>

  <div class="quiz-modal" id="quizModal"> <div class="quiz-content"> <button class="quiz-close" id="quizClose" aria-label="Close quiz">×</button> <div class="quiz-timer" id="quizTimer">10:00</div> <h2><i class="fas fa-stopwatch" style="margin-right: 10px;"></i>Quick Proficiency Test</h2> <div id="quizQuestionContainer"></div> <div class="quiz-navigation"> <button id="prevBtn" disabled><i class="fas fa-chevron-left" style="margin-right: 5px;"></i> Previous</button> <button id="nextBtn">Next <i class="fas fa-chevron-right" style="margin-left: 5px;"></i></button> </div> <div class="quiz-result" id="quizResult"></div> </div> </div>

  <script>
    // --- Data (Keep Existing) ---
    const stepImages = { 0:{unselected:"https://i.imgur.com/KIQtM2C.png",selected:"https://i.imgur.com/KIQtM2C.png"},1:{unselected:"https://i.imgur.com/UXcjjjX.png",selected:"https://i.imgur.com/D63Fs1Z.png"},2:{unselected:"https://i.imgur.com/hpAUX4v.png",selected:"https://i.imgur.com/n2lCCgL.png"},3:{unselected:"https://i.imgur.com/yBfufkz.png",selected:"https://i.imgur.com/XrkPumH.png"},4:{unselected:"https://i.imgur.com/0022wYw.png",selected:"https://i.imgur.com/TxrBSwK.png"},5:{unselected:"https://i.imgur.com/lm52jxZ.png",selected:"https://i.imgur.com/skPL7DJ.png"},6:{unselected:"https://i.imgur.com/6nCnK6C.png",selected:"https://i.imgur.com/6nCnK6C.png"}};
    const proficiencyLevels = [ { name: "Beginner", description: "Starting your English journey or know just a few basic words and phrases." }, { name: "A1", description: "Can understand and use familiar everyday expressions and basic phrases aimed at satisfying basic needs." }, { name: "A2", description: "Can communicate in simple and routine tasks requiring a direct exchange of information on familiar topics." }, { name: "B1", description: "Can understand the main points of clear standard input on familiar matters regularly encountered." }, { name: "B2", description: "Can understand the main ideas of complex text on both concrete and abstract topics, including technical discussions." }, { name: "C1", description: "Can express ideas fluently and spontaneously without much obvious searching for expressions." }, { name: "Fluent", description: "Can understand with ease virtually everything heard or read; express self spontaneously, very fluently and precisely." } ];
    const levelMapping = { "Beginner": 0, "A1": 1, "A2": 2, "B1": 3, "B2": 4, "C1": 5, "Fluent": 6 };
    const scoring = { "A1":{correct:0.75,wrong:-0.25},"A2":{correct:1.5,wrong:-0.5},"B1":{correct:2.25,wrong:-0.75},"B2":{correct:3.0,wrong:-1.0},"C1":{correct:3.75,wrong:-1.25}}; const poolA1 = [ {question:"Which one is a color?",options:{A:"red",B:"table",C:"run",D:"quickly"},correct:"A",level:"A1"},{question:"Which sentence is correct?",options:{A:"I am happy.",B:"Am I happy.",C:"I happy am.",D:"Happy I am."},correct:"A",level:"A1"},{question:'Choose the correct article: "____ apple a day keeps the doctor away."',options:{A:"a",B:"an",C:"the",D:"(no article)"},correct:"B",level:"A1"},{question:"Which word is a noun?",options:{A:"cat",B:"blue",C:"quickly",D:"run"},correct:"A",level:"A1"},{question:"Which one is a greeting?",options:{A:"Goodbye",B:"Hello",C:"Thanks",D:"Sorry"},correct:"B",level:"A1"},{question:"What is the opposite of 'big'?",options:{A:"small",B:"red",C:"tall",D:"fast"},correct:"A",level:"A1"},{question:'Complete the sentence with the correct preposition: "The cat is ___ the table."',options:{A:"on",B:"in",C:"under",D:"with"},correct:"A",level:"A1"},{question:"Which word is a verb?",options:{A:"sleep",B:"green",C:"happy",D:"chair"},correct:"A",level:"A1"},{question:"Which word is spelled correctly?",options:{A:"frend",B:"friend",C:"freind",D:"frend"},correct:"B",level:"A1"},{question:"Which sentence uses proper punctuation?",options:{A:'"How are you", he asked?',B:"How are you he asked.",C:'"How are you?" he asked.',D:"How are you? he asked."},correct:"C",level:"A1"}]; const poolA2 = [ {question:"Choose the correct sentence:",options:{A:"I has breakfast at 7 AM.",B:"I have breakfast at 7 AM.",C:"I having breakfast at 7 AM.",D:"I had breakfast at 7 AM."},correct:"B",level:"A2"},{question:'Fill in the blank: "She ______ to work every day."',options:{A:"drive",B:"driving",C:"drives",D:"drove"},correct:"C",level:"A2"},{question:'Select the past tense form: "Yesterday, they ______ a new movie."',options:{A:"watch",B:"watched",C:"watching",D:"watches"},correct:"B",level:"A2"},{question:'Identify the correct possessive adjective: "This is ______ car."',options:{A:"him",B:"his",C:"he",D:"her"},correct:"B",level:"A2"},{question:"Which sentence is a proper question?",options:{A:"You are coming tonight?",B:"Are you coming tonight?",C:"Coming you tonight are?",D:"Tonight are you coming?"},correct:"B",level:"A2"},{question:'Choose the correct comparative form: "My house is ______ than yours."',options:{A:"big",B:"bigger",C:"biggest",D:"more big"},correct:"B",level:"A2"},{question:"Select the sentence with correct word order:",options:{A:"When do you usually get up?",B:"You usually do get up when?",C:"Do when you usually get up?",D:"When usually do you get up?"},correct:"A",level:"A2"},{question:'Fill in with the appropriate preposition: "They will meet ______ the park."',options:{A:"in",B:"at",C:"on",D:"to"},correct:"B",level:"A2"},{question:'Choose the correct modal verb: "You ______ finish your homework before playing."',options:{A:"must",B:"can",C:"may",D:"might"},correct:"A",level:"A2"},{question:'Select the correct connector: "I wanted to go out, ______ it was raining."',options:{A:"so",B:"but",C:"because",D:"although"},correct:"B",level:"A2"}]; const poolB1 = [ {question:"If it ______ tomorrow, we will cancel the picnic.",options:{A:"rains",B:"rained",C:"will rain",D:"raining"},correct:"A",level:"B1"},{question:"I have lived in London ______ 2010.",options:{A:"since",B:"for",C:"from",D:"in"},correct:"A",level:"B1"},{question:"They ______ in that house when I visited them last year.",options:{A:"were staying",B:"stayed",C:"used to stay",D:"had stayed"},correct:"A",level:"B1"},{question:"Which sentence is correct?",options:{A:"He don't like coffee.",B:"He doesn't like coffee.",C:"He didn't likes coffee.",D:"He doesn't likes coffee."},correct:"B",level:"B1"},{question:"I ______ to the party if I had known about it.",options:{A:"would go",B:"would have gone",C:"will go",D:"had gone"},correct:"B",level:"B1"},{question:'Choose the correct preposition: "She is interested ______ learning languages."',options:{A:"in",B:"on",C:"at",D:"for"},correct:"A",level:"B1"},{question:'Which word is closest in meaning to "generate"?',options:{A:"produce",B:"consume",C:"eliminate",D:"reduce"},correct:"A",level:"B1"},{question:'Select the correct passive form: "They will build a new bridge next year."',options:{A:"A new bridge will be built next year.",B:"Next year a new bridge is built.",C:"A new bridge built next year.",D:"A new bridge will built next year."},correct:"A",level:"B1"},{question:'Complete the sentence correctly: "I’m used to ______ early in the morning."',options:{A:"get up",B:"getting up",C:"to get up",D:"gets up"},correct:"B",level:"B1"},{question:"Which sentence is in the present perfect tense?",options:{A:"She has finished her work.",B:"She finished her work.",C:"She is finishing her work.",D:"She will finish her work."},correct:"A",level:"B1"}]; const poolB2 = [ {question:"Which sentence correctly expresses a mixed conditional?",options:{A:"If I hadn’t missed the bus, I would be here on time.",B:"If I miss the bus, I would be here on time.",C:"If I missed the bus, I would have been here on time.",D:"If I hadn’t missed the bus, I would have been here on time."},correct:"A",level:"B2"},{question:"Select the sentence that correctly uses the past perfect tense:",options:{A:"By the time we arrived, the movie started.",B:"By the time we arrived, the movie has started.",C:"By the time we arrived, the movie had already started.",D:"By the time we arrived, the movie starts already."},correct:"C",level:"B2"},{question:"Which sentence correctly incorporates a non-defining relative clause?",options:{A:"The book that I borrowed from the library is fascinating.",B:"The book, which I borrowed from the library, is fascinating.",C:"The book, that I borrowed from the library, is fascinating.",D:"The book which I borrowed from the library is fascinating."},correct:"B",level:"B2"},{question:"Identify the correctly reported speech transformation:",options:{A:'He said, "I feel sick." → He said that he felt sick.',B:'He said, "I feel sick." → He said that he feels sick.',C:'He said, "I feel sick." → He said that he was feeling sick.',D:'He said, "I feel sick." → He said that he had felt sick.'},correct:"C",level:"B2"},{question:"Which sentence correctly expresses a suggestion using “should”?",options:{A:"You should to try speaking more English.",B:"You should try to speak more English.",C:"You ought try to speak more English.",D:"You should tried to speak more English."},correct:"B",level:"B2"},{question:'Complete the sentence correctly: "No sooner had I reached the station ______."',options:{A:"than the train left.",B:"when the train left.",C:"the train left.",D:"then the train left."},correct:"A",level:"B2"},{question:"Which sentence correctly uses the passive voice?",options:{A:"The cake baked by my mother.",B:"The cake was baked by my mother.",C:"My mother baked the cake by.",D:"The cake is baking by my mother."},correct:"B",level:"B2"},{question:"Select the sentence that correctly expresses past obligation:",options:{A:"I had to finish the report by yesterday.",B:"I must finished the report by yesterday.",C:"I should finish the report by yesterday.",D:"I had finish the report by yesterday."},correct:"A",level:"B2"},{question:"Which sentence correctly uses a gerund after a preposition?",options:{A:"He is interested to learn about economics.",B:"He is interested in learn about economics.",C:"He is interested in learning about economics.",D:"He is interested on learning about economics."},correct:"C",level:"B2"},{question:"Identify the sentence with correct subject–verb agreement in a complex structure:",options:{A:"Either the manager or the employees is going to attend the meeting.",B:"Either the manager or the employees are going to attend the meeting.",C:"Either the managers or the employee are going to attend the meeting.",D:"Either the manager and the employees are going to attend the meeting."},correct:"B",level:"B2"}]; const poolC1 = [ {question:"Choose the sentence that correctly uses inversion for a conditional statement:",options:{A:"Should you require further details, please let me know.",B:"If you require further details, please let me know.",C:"Should you required further details, please let me know.",D:"Were you require further details, please let me know."},correct:"A",level:"C1"},{question:"Identify the sentence that correctly employs the present perfect continuous tense:",options:{A:"I have been working on the report all morning.",B:"I worked on the report all morning.",C:"I have worked on the report all morning.",D:"I am working on the report all morning."},correct:"A",level:"C1"},{question:"Which sentence uses a non-restrictive relative clause appropriately?",options:{A:"The seminar, which was organized last month, attracted top experts in the field.",B:"The seminar which was organized last month attracted top experts in the field.",C:"The seminar, that was organized last month, attracted top experts in the field.",D:"The seminar that was organized last month, attracted top experts in the field."},correct:"A",level:"C1"},{question:"Select the sentence that demonstrates advanced vocabulary usage in context:",options:{A:"The groundbreaking study received resounding acclaim from the academic community.",B:"The groundbreaking study received lukewarm acclaim from the academic community.",C:"The groundbreaking study received tepid acclaim from the academic community.",D:"The groundbreaking study received equivocal acclaim from the academic community."},correct:"A",level:"C1"},{question:"Which sentence correctly uses the future perfect tense?",options:{A:"By next month, the committee will have finalized the new guidelines.",B:"By next month, the committee will finalize the new guidelines.",C:"By next month, the committee finalized the new guidelines.",D:"By next month, the committee finalizes the new guidelines."},correct:"A",level:"C1"},{question:"Identify the sentence that correctly employs correlative conjunctions:",options:{A:"Both the researchers and the participants contributed significantly to the study.",B:"Either the researchers or the participants contributed significantly to the study.",C:"Both the researchers or the participants contributed significantly to the study.",D:"Neither the researchers and the participants contributed significantly to the study."},correct:"A",level:"C1"},{question:"Choose the sentence that uses the passive voice appropriately in an academic context:",options:{A:"The manuscript, which had been rigorously peer-reviewed, was published in a leading journal.",B:"The manuscript, rigorously peer-reviewed, published in a leading journal.",C:"The manuscript, which rigorously peer-reviewed, was published in a leading journal.",D:"The manuscript was rigorously peer-reviewed and publishing in a leading journal."},correct:"A",level:"C1"},{question:"Select the sentence that correctly applies a mixed conditional structure:",options:{A:"If I had accepted that offer, I would be enjoying a career abroad now.",B:"If I accepted that offer, I would be enjoying a career abroad now.",C:"If I had accepted that offer, I would enjoy a career abroad now.",D:"If I accepted that offer, I would have enjoyed a career abroad now."},correct:"A",level:"C1"},{question:"Which sentence conveys uncertainty using modal verbs correctly?",options:{A:"He might have been mistaken about the project's feasibility.",B:"He must have been mistaken about the project's feasibility.",C:"He could have been mistaken about the project's feasibility.",D:"He should have been mistaken about the project's feasibility."},correct:"A",level:"C1"},{question:"Choose the sentence that correctly uses an advanced idiom:",options:{A:"Despite the obstacles, she decided to bite the bullet and implement the changes.",B:"Despite the obstacles, she decided to take the bullet and implement the changes.",C:"Despite the obstacles, she decided to bite a bullet and implement the changes.",D:"Despite the obstacles, she decided to shoot the bullet and implement the changes."},correct:"A",level:"C1"}];

    // --- DOM Elements ---
    const els = { // Group elements in an object for easier access
        levelSelectorItemsContainer: document.getElementById('levelSelectorItems'),
        levelDescriptionArea: document.getElementById('levelDescriptionArea'),
        descriptionParagraph: document.getElementById('levelDescriptionArea')?.querySelector('p'),
        continueButton: document.getElementById('continueButton'),
        nativeLangOptionsContainer: document.getElementById('nativeLanguageOptions'),
        submissionFeedback: document.getElementById('submissionFeedback'),
        quizModal: document.getElementById('quizModal'),
        quizCloseBtn: document.getElementById('quizClose'),
        openQuizBtn: document.getElementById('openQuiz'),
        // Header Elements
        signInLink: document.getElementById('signInLink'),
        userProfileHeader: document.getElementById('user-profile-header'),
        userNameHeader: document.getElementById('userNameHeader'),
        userAvatarHeader: document.getElementById('userAvatarHeader'),
        profileDropdown: document.getElementById('profileDropdown'),
        signOutBtn: document.getElementById('signOutBtn'),
        notificationDot: document.getElementById('notificationDot'),
        lessonsNotificationDot: document.getElementById('lessonsNotificationDot')
    };

    // --- State Variables ---
    let selectedProficiencyIndex = -1;
    let selectedNativeLang = 'arabic'; // Default
    let isQuizSelected = false; // Flag to track if level was set by quiz

    // --- Utility Functions ---

    // Add this line BEFORE the apiRequest function definition
    const API_BASE_URL = 'https://api.fireship.org'; // <-- YOUR LIVE API URL

    async function apiRequest(url, options) {
         // Construct the full URL if the provided URL starts with '/'
         const fullUrl = url.startsWith('/') ? `${API_BASE_URL}${url}` : url; // Use the constant
         console.debug(`API Req: ${options?.method || 'GET'} ${fullUrl}`); // Log the full URL
         try {
             // Use fullUrl in the fetch call
             const r = await fetch(fullUrl, options); // <--- Ensure this uses fullUrl

             if (!r.ok) {
                 let errorMsg = `API Error (${r.status})`;
                 let errorData = null;
                 try { errorData = await r.json(); errorMsg = errorData.message || errorMsg; } catch (e) { /* ignore if response is not json */ }
                 console.error(`API Fail: ${r.status} ${r.statusText} @ ${fullUrl}`, errorData); // Log fullUrl

                 // Special handling for 401 (Unauthorized) - redirect to welcome
                 if (r.status === 401 && !fullUrl.includes('/api/auth/logout')) { // Don't redirect on logout failure
                     console.warn("API 401 Unauthorized detected, redirecting to welcome page.");
                     window.location.href = 'welcome.html';
                     return null; // Prevent further processing after redirect trigger
                 }
                 // Throw a formatted error
                 throw new Error(errorData?.message || `Request failed: ${r.status}`);
             }

             // Check content type before trying to parse JSON
             const ct = r.headers.get("content-type");
             if (ct?.includes("application/json")) {
                 const d = await r.json();
                 console.debug(`API OK JSON @ ${fullUrl}:`, d); // Log fullUrl
                 return d;
             } else {
                 // For non-JSON responses (like maybe logout), return success indication
                 console.debug(`API OK NoJSON @ ${fullUrl} (${r.status})`); // Log fullUrl
                 return { success: true }; // Or return {}; if preferred
             }
         } catch (e) { // Error handling
              console.error(`API Excep (${fullUrl}):`, e); // <--- Ensure this uses fullUrl
              // Handle specific error types if needed, e.g., network errors
              if (e.message.toLowerCase().includes('failed to fetch')) {
                  throw new Error("Network error. Please check your connection.");
              }
              // Re-throw other errors (could be the custom error from !r.ok or the network error)
              throw e;
         }
    }


    function showButtonLoading(button, isLoading) {
        // (Keep existing showButtonLoading function)
         if (!button) return;
        const btnText = button.querySelector('.btn-text');
        const btnLoader = button.querySelector('.btn-loader');
        const btnIcon = button.querySelector('.btn-icon');

        button.disabled = isLoading;
        button.classList.toggle('loading', isLoading);

        if (btnText) btnText.style.display = isLoading ? 'none' : 'inline';
        if (btnLoader) btnLoader.style.display = isLoading ? 'inline-block' : 'none';
        // If you want the icon to *always* show when not loading, adjust this:
        // if (btnIcon) btnIcon.style.display = isLoading ? 'none' : 'inline-block';
        // If icon is *part* of the loading state (e.g., spinner icon):
        if (btnIcon) btnIcon.style.display = isLoading ? 'inline-block' : 'none'; // Show icon only when loading? Check your CSS/HTML structure
    }

     function showFeedback(message, isError = false) {
        // (Keep existing function)
        if (els.submissionFeedback) {
            els.submissionFeedback.textContent = message;
            els.submissionFeedback.className = isError ? 'error' : 'success';
            els.submissionFeedback.style.display = 'block';
        } else {
            alert(message); // Fallback
        }
    }

    function clearFeedback() {
         // (Keep existing function)
        if (els.submissionFeedback) {
            els.submissionFeedback.textContent = '';
            els.submissionFeedback.style.display = 'none';
        }
    }

    // --- Fetch and Pre-fill Data ---
    async function fetchAndPrefillProficiency() {
        // (Keep existing function)
        console.log("Attempting to fetch existing proficiency data...");
        try {
            // Use the updated apiRequest function
            const prefs = await apiRequest('/api/user/preferences/proficiency', { method: 'GET' });
            if (prefs === null) return; // Redirect happened or fatal API error in apiRequest

            console.log("Fetched proficiency data:", prefs);

            if (prefs && Object.keys(prefs).length > 0) {
                // Pre-select Native Language
                if (prefs.nativeLanguage) {
                    selectedNativeLang = prefs.nativeLanguage;
                    const langOption = els.nativeLangOptionsContainer?.querySelector(`.language-option[data-lang="${prefs.nativeLanguage}"]`);
                    if (langOption) {
                        els.nativeLangOptionsContainer?.querySelectorAll('.language-option').forEach(opt => opt.classList.remove('selected'));
                        langOption.classList.add('selected');
                    }
                }

                // Pre-select Proficiency Level
                if (prefs.level) {
                    const levelIndex = levelMapping[prefs.level];
                    if (levelIndex !== undefined && levelIndex >= 0) {
                        selectProficiency(levelIndex, prefs.quizSelected || false); // Pass fetched quiz status
                        console.log(`Pre-selected level: ${prefs.level} (Index: ${levelIndex}), Quiz: ${prefs.quizSelected || false}`);
                        if (els.continueButton) els.continueButton.disabled = false;
                    } else {
                         // Handle case where fetched level name is invalid
                         console.warn(`Fetched level "${prefs.level}" not found in mapping.`);
                         if (els.continueButton) els.continueButton.disabled = true; // Force selection if fetched level is bad
                    }
                } else {
                    // If level is missing, but native language is set, don't disable button initially, require selection
                    if (prefs.nativeLanguage && els.continueButton) {
                         els.continueButton.disabled = true; // Requires level selection
                         updateDescriptionArea(-1); // Show placeholder text
                    }
                }
                 console.log("Proficiency form pre-filled.");
            } else {
                 console.log("No existing proficiency data found.");
                 // Ensure default native language is selected visually if no data fetched
                 const defaultLangOption = els.nativeLangOptionsContainer?.querySelector(`.language-option[data-lang="${selectedNativeLang}"]`);
                 if (defaultLangOption && !els.nativeLangOptionsContainer?.querySelector('.language-option.selected')) {
                      defaultLangOption.classList.add('selected');
                 }
                 // Ensure button is disabled if no level prefilled
                 if (els.continueButton) els.continueButton.disabled = true;
                 updateDescriptionArea(-1); // Show placeholder text
            }
        } catch (error) {
            console.warn("Could not fetch proficiency data:", error.message);
             // Ensure default language is selected visually on error too
             const defaultLangOption = els.nativeLangOptionsContainer?.querySelector(`.language-option[data-lang="${selectedNativeLang}"]`);
              if (defaultLangOption && !els.nativeLangOptionsContainer?.querySelector('.language-option.selected')) {
                   defaultLangOption.classList.add('selected');
              }
             // Keep button disabled on fetch error
             if (els.continueButton) els.continueButton.disabled = true;
             updateDescriptionArea(-1);
        }
    }


    // --- UI Generation and Interaction ---
    function generateLevelSelectorItems() {
        // (Keep existing function)
        if (!els.levelSelectorItemsContainer) return;
        els.levelSelectorItemsContainer.innerHTML = '';
        proficiencyLevels.forEach((level, index) => {
            const item = document.createElement('div');
            item.classList.add('proficiency-level-item');
            item.dataset.index = index;
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('level-image-container');
            const img = document.createElement('img');
            const imgSrc = stepImages[index]?.unselected;
            if (imgSrc) { img.src = imgSrc; img.alt = level.name; }
            else { img.alt = `${level.name} (Image missing)`; }
            imageContainer.appendChild(img);
            const label = document.createElement('div');
            label.classList.add('level-label');
            label.textContent = level.name;
            item.appendChild(imageContainer);
            item.appendChild(label);
            item.addEventListener('click', () => selectProficiency(index, false)); // Manual selection
            els.levelSelectorItemsContainer.appendChild(item);
        });
    }

    function updateDescriptionArea(index) {
         // (Keep existing function)
        if (!els.descriptionParagraph) return;
        els.descriptionParagraph.classList.add('fade-out');
        els.descriptionParagraph.classList.remove('fade-in');
        setTimeout(() => {
            if (index >= 0 && index < proficiencyLevels.length) {
                els.descriptionParagraph.textContent = proficiencyLevels[index].description;
                els.descriptionParagraph.classList.remove('placeholder');
            } else {
                els.descriptionParagraph.textContent = "Select a level above to see its description.";
                els.descriptionParagraph.classList.add('placeholder');
            }
            els.descriptionParagraph.classList.remove('fade-out');
            els.descriptionParagraph.classList.add('fade-in');
        }, 150); // Match CSS transition
    }

    function selectProficiency(selectedIndex, viaQuiz = false) {
        // (Keep existing function)
        if (selectedIndex < 0 || selectedIndex >= proficiencyLevels.length || !els.levelSelectorItemsContainer) return;

        console.log(`Proficiency selected: Index ${selectedIndex}, viaQuiz: ${viaQuiz}`);
        selectedProficiencyIndex = selectedIndex;
        isQuizSelected = viaQuiz; // Set the flag based on how selection happened

        const items = els.levelSelectorItemsContainer.querySelectorAll('.proficiency-level-item');
        items.forEach((item, index) => {
            const img = item.querySelector('img');
            if (!img) return;
            const isCurrentlySelected = index === selectedIndex;
            item.classList.toggle('selected', isCurrentlySelected);
            img.src = stepImages[index]?.[isCurrentlySelected ? 'selected' : 'unselected'] || stepImages[index]?.unselected || '';
        });

        updateDescriptionArea(selectedIndex);
        if (els.continueButton) {
            els.continueButton.disabled = false;
        }
    }

    function setupNativeLanguageSelection() {
        // (Keep existing function)
        if (!els.nativeLangOptionsContainer) return;
        els.nativeLangOptionsContainer.addEventListener('click', (event) => {
            const targetOption = event.target.closest('.language-option');
            if (!targetOption) return;

            els.nativeLangOptionsContainer.querySelectorAll('.language-option').forEach(opt => opt.classList.remove('selected'));
            targetOption.classList.add('selected');
            selectedNativeLang = targetOption.dataset.lang;
            console.log("Native language selected:", selectedNativeLang);
        });
    }

    // --- Continue Button Logic ---
    async function handleContinue() {
         // (Keep existing function)
        clearFeedback();
        if (selectedProficiencyIndex === -1) {
            showFeedback("Please select your proficiency level first.", true);
            return;
        }

        const selectedLevelName = proficiencyLevels[selectedProficiencyIndex].name;
        const dataToSend = {
            nativeLanguage: selectedNativeLang,
            level: selectedLevelName,
            quizSelected: isQuizSelected // Include the quiz status flag
        };

        console.log("Continue clicked. Submitting proficiency data:", dataToSend);
        showButtonLoading(els.continueButton, true);

        try {
            // Use the updated apiRequest function
            const result = await apiRequest('/api/user/preferences/proficiency', {
                 method: 'POST', // Or PUT
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(dataToSend)
            });

            if (result === null) { // Redirect happened or fatal API error
                 // Button loading state might need reset if redirect doesn't happen immediately
                 // showButtonLoading(els.continueButton, false); // Consider adding this if needed
                 return;
            }

            console.log("Proficiency data saved successfully.");
            window.location.href = 'booking.html'; // Redirect to booking page

        } catch (error) {
            console.error("Failed to save proficiency data:", error);
            showFeedback(`Error saving data: ${error.message}`, true);
            showButtonLoading(els.continueButton, false);
        }
    }


    // --- Quiz Code (Keep Existing) ---
    let quizQuestions = []; let currentQuestion = 0; let questionScores = {}; let timerInterval;
    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; } function selectRandomQuestions() { const selected = []; [poolA1, poolA2, poolB1, poolB2, poolC1].forEach(pool => { const shuffled = shuffle([...pool]); if (shuffled.length >= 2) { selected.push(shuffled[0], shuffled[1]); } else if (shuffled.length === 1) { selected.push(shuffled[0]); } }); while(selected.length < 10 && selected.length > 0) { const randomPool = [poolA1, poolA2, poolB1, poolB2, poolC1][Math.floor(Math.random() * 5)]; const randomQuestion = randomPool[Math.floor(Math.random() * randomPool.length)]; if (!selected.some(q => q.question === randomQuestion.question)) { selected.push(randomQuestion); } } return selected.slice(0, 10); } function loadQuestion(index) { if (index < 0 || index >= quizQuestions.length) return; const q = quizQuestions[index]; const quizContainer = document.getElementById("quizQuestionContainer"); const prevBtn = document.getElementById("prevBtn"); const nextBtn = document.getElementById("nextBtn"); if (!quizContainer || !prevBtn || !nextBtn) return; let html = `<div class="quiz-question"><p>Q${index + 1} (${q.level}): ${q.question}</p></div><div class="quiz-options">`; const previousAnswer = questionScores[index]?.selectedAnswer; for (let key in q.options) { const isChecked = previousAnswer === key ? 'checked' : ''; const uniqueId = `q${index}_${key}`; html += `<input type="radio" id="${uniqueId}" name="quizOption" value="${key}" ${isChecked} style="display:none;"><label for="${uniqueId}"><span>(${key})</span> ${q.options[key]}</label>`; } html += `</div>`; quizContainer.innerHTML = html; prevBtn.disabled = index === 0; nextBtn.innerHTML = (index === quizQuestions.length - 1) ? `Submit Answers <i class="fas fa-check" style="margin-left: 5px;"></i>` : `Next <i class="fas fa-chevron-right" style="margin-left: 5px;"></i>`; const radioLabels = quizContainer.querySelectorAll('.quiz-options label'); radioLabels.forEach(label => { label.addEventListener('click', function() { radioLabels.forEach(l => l.style.backgroundColor = ''); const radioInput = document.getElementById(this.getAttribute('for')); if (radioInput) { radioInput.checked = true; this.style.backgroundColor = 'rgba(90, 141, 238, 0.15)'; const currentQ = quizQuestions[currentQuestion]; const s = scoring[currentQ.level] || { correct: 0, wrong: 0 }; questionScores[currentQuestion] = { score: (radioInput.value === currentQ.correct) ? s.correct : s.wrong, selectedAnswer: radioInput.value }; } }); }); if (previousAnswer) { const selectedLabel = quizContainer.querySelector(`label[for="q${index}_${previousAnswer}"]`); if (selectedLabel) selectedLabel.style.backgroundColor = 'rgba(90, 141, 238, 0.15)'; } } function determineLevel(totalScore) { if (totalScore <= 0) return "A1"; else if (totalScore <= 6) return "A2"; else if (totalScore <= 12) return "B1"; else if (totalScore <= 18) return "B2"; else if (totalScore > 18) return "C1"; else return "A1"; } function showFinalLevelBackground(finalLevel) { const levelIndex = levelMapping[finalLevel] ?? 1; const bgSrc = stepImages[levelIndex]?.selected ?? ""; const quizContent = document.querySelector(".quiz-content"); if(bgSrc && quizContent) { let bgDiv = quizContent.querySelector(".quiz-bg"); if (!bgDiv) { bgDiv = document.createElement("div"); bgDiv.className = "quiz-bg"; Object.assign(bgDiv.style, { position: 'absolute', top: '0', left: '0', width: '100%', height: '100%', zIndex: '-1', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', backgroundSize: 'contain', opacity: '0.08', borderRadius: 'inherit' }); quizContent.style.position = 'relative'; quizContent.prepend(bgDiv); } bgDiv.style.backgroundImage = `url(${bgSrc})`; } } function submitQuiz() { stopTimer(); let totalScore = 0; for (let i = 0; i < quizQuestions.length; i++) { totalScore += questionScores[i]?.score || 0; } const finalLevel = determineLevel(totalScore); const quizContainer = document.getElementById("quizQuestionContainer"); const quizNav = document.querySelector(".quiz-navigation"); const quizResult = document.getElementById("quizResult"); const quizTimer = document.getElementById("quizTimer"); if(quizContainer) quizContainer.innerHTML = ""; if(quizNav) quizNav.style.display = "none"; if(quizTimer) quizTimer.style.display = 'none'; if(quizResult) { quizResult.innerHTML = `<div class="final-message"> <p>Your estimated English level is ${finalLevel}.</p> <button id="gotItBtn">Got it</button> </div>`; document.getElementById("gotItBtn")?.addEventListener("click", function() { closeQuiz(finalLevel); }); } showFinalLevelBackground(finalLevel); } document.getElementById("nextBtn")?.addEventListener("click", function() { if (!questionScores[currentQuestion] && !document.querySelector('input[name="quizOption"]:checked')) { questionScores[currentQuestion] = { score: 0, selectedAnswer: null }; } if (currentQuestion === quizQuestions.length - 1) { submitQuiz(); } else { currentQuestion++; loadQuestion(currentQuestion); } }); document.getElementById("prevBtn")?.addEventListener("click", function() { if (currentQuestion > 0) { currentQuestion--; loadQuestion(currentQuestion); } }); function startTimer(duration) { clearInterval(timerInterval); let time = duration; const quizTimer = document.getElementById('quizTimer'); if (!quizTimer) return; quizTimer.style.display = 'block'; quizTimer.textContent = formatTime(time); timerInterval = setInterval(() => { time--; quizTimer.textContent = formatTime(time); if (time <= 0) { clearInterval(timerInterval); submitQuizAutomatically(); } }, 1000); } function submitQuizAutomatically() { console.log("Quiz timer expired."); stopTimer(); let totalScore = 0; for (let i = 0; i < quizQuestions.length; i++) { totalScore += questionScores[i]?.score || 0; } const finalLevel = determineLevel(totalScore); const quizContainer = document.getElementById("quizQuestionContainer"); const quizNav = document.querySelector(".quiz-navigation"); const quizResult = document.getElementById("quizResult"); const quizTimer = document.getElementById("quizTimer"); if(quizContainer) quizContainer.innerHTML = "<p style='text-align:center; color: var(--accent-color); font-weight: bold;'>Time's up!</p>"; if(quizNav) quizNav.style.display = "none"; if(quizTimer) quizTimer.style.display = 'none'; if(quizResult) { quizResult.innerHTML = `<div class="final-message"> <p>Time's up! Your estimated level based on answered questions is ${finalLevel}.</p> <button id="gotItBtn">Got it</button> </div>`; document.getElementById("gotItBtn")?.addEventListener("click", function() { closeQuiz(finalLevel); }); } showFinalLevelBackground(finalLevel); } function stopTimer() { clearInterval(timerInterval); } function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m < 10 ? "0" : ""}${m}:${s < 10 ? "0" : ""}${s}`; }
    function closeQuiz(finalLevel = null) { // Keep existing modified closeQuiz
        if (els.quizModal) els.quizModal.style.display = 'none';
        stopTimer();
        if(finalLevel && levelMapping[finalLevel] !== undefined) {
            const levelIndex = levelMapping[finalLevel];
            console.log(`Quiz closed, setting proficiency index to: ${levelIndex} (${finalLevel}) via Quiz`);
            selectProficiency(levelIndex, true); // Pass true for viaQuiz
        } else {
            console.log("Quiz closed without determining/setting a final level.");
        }
        // Reset quiz UI elements
        const quizContent = document.querySelector(".quiz-content"); const bgDiv = quizContent?.querySelector(".quiz-bg"); if(bgDiv) bgDiv.remove(); const quizNav = document.querySelector(".quiz-navigation"); if(quizNav) quizNav.style.display = "flex"; const quizResult = document.getElementById("quizResult"); if(quizResult) quizResult.innerHTML = ""; const quizContainer = document.getElementById("quizQuestionContainer"); if(quizContainer) quizContainer.innerHTML = ""; const quizTimer = document.getElementById("quizTimer"); if(quizTimer) quizTimer.style.display = 'block';
    }
    els.openQuizBtn?.addEventListener('click', function() { /* (Keep existing code) */ quizQuestions = selectRandomQuestions(); if (quizQuestions.length === 0) { alert("Error: Could not load quiz questions."); return; } currentQuestion = 0; questionScores = {}; const nextBtn = document.getElementById("nextBtn"); const prevBtn = document.getElementById("prevBtn"); const quizResult = document.getElementById("quizResult"); const quizNav = document.querySelector(".quiz-navigation"); if (nextBtn) { nextBtn.disabled = false; nextBtn.innerHTML = (quizQuestions.length === 1) ? `Submit Answers <i class="fas fa-check" style="margin-left: 5px;"></i>` : `Next <i class="fas fa-chevron-right" style="margin-left: 5px;"></i>`; } if(prevBtn) prevBtn.disabled = true; if (quizResult) quizResult.textContent = ""; if (quizNav) quizNav.style.display = "flex"; const quizContent = document.querySelector(".quiz-content"); const existingBg = quizContent?.querySelector(".quiz-bg"); if(existingBg) existingBg.remove(); if(els.quizModal) els.quizModal.style.display = 'flex'; loadQuestion(currentQuestion); startTimer(10 * 60); });
    els.quizCloseBtn?.addEventListener('click', () => closeQuiz());

     // --- Header Logic Functions (Keep Existing) ---
    function updateHeaderUI(userData, hasBooking) {
        const { signInLink, userProfileHeader, userNameHeader, userAvatarHeader, notificationDot, lessonsNotificationDot } = els;
        if (userData && userProfileHeader && userNameHeader && userAvatarHeader && signInLink) {
            signInLink.style.display = 'none';
            userProfileHeader.style.display = 'flex';
            userNameHeader.textContent = userData.name || 'User';
            userAvatarHeader.src = userData.avatarUrl || 'placeholder-avatar.png';
            userAvatarHeader.onerror = () => { if (userAvatarHeader) userAvatarHeader.src = 'placeholder-avatar.png'; }; // Added check
            if (notificationDot) notificationDot.style.display = hasBooking ? 'block' : 'none';
            if (lessonsNotificationDot) lessonsNotificationDot.classList.toggle('visible', hasBooking);
        } else if (signInLink && userProfileHeader) {
            signInLink.style.display = 'block';
            userProfileHeader.style.display = 'none';
            if (notificationDot) notificationDot.style.display = 'none';
            if (lessonsNotificationDot) lessonsNotificationDot.classList.remove('visible');
        }
    }

    function setupDropdown() {
        const { userProfileHeader, profileDropdown } = els;
        if (userProfileHeader && profileDropdown) {
            userProfileHeader.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent window listener from closing it immediately
                profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
            });
            // Close dropdown if clicking outside
            window.addEventListener('click', (event) => {
                if (profileDropdown.style.display === 'block' && !userProfileHeader.contains(event.target)) {
                    profileDropdown.style.display = 'none';
                }
            });
        } else {
             console.warn("Could not set up dropdown - elements missing.");
        }
    }

    async function handleSignOut() {
        console.log("Signing out...");
        try {
            // Use the updated apiRequest
            const result = await apiRequest('/api/auth/logout', { method: 'POST' });
             if (result === null) return; // Redirect happened in apiRequest
            // Fallback redirect
            window.location.href = 'welcome.html'; // Redirect after successful logout
        } catch (error) {
            console.error("Sign out failed:", error);
             if (error.message !== "Redirecting") { // Avoid alert if it was a redirect signal
                 alert(`Sign out failed: ${error.message}`);
             }
        }
    }

    async function checkAuthAndSetupHeader() {
        console.log("[Header Auth Check] Checking...");
        try {
            // Use the updated apiRequest
            const status = await apiRequest('/api/user/status', { method: 'GET' });
            if (status === null) return; // Redirect happened or fatal API error

            if (status && status.user) {
                console.log("[Header Auth Check] User logged in:", status.user);
                updateHeaderUI(status.user, status.hasBooking || false);
            } else {
                console.log("[Header Auth Check] User not logged in.");
                 // Proficiency page usually requires login, redirect or show message
                 updateHeaderUI(null, false);
                 console.warn("User not logged in on proficiency page. Redirecting to welcome.");
                 window.location.href = 'welcome.html'; // Redirect if not logged in
            }
        } catch (error) {
            console.warn("[Header Auth Check] Failed:", error.message);
            updateHeaderUI(null, false);
             // Consider showing an error message or redirecting on auth error too
             // showFeedback("Error checking login status. Please refresh.", true);
             console.error("Auth check failed, potentially redirecting.");
             // window.location.href = 'welcome.html'; // Optionally redirect on error
        }
    }


    // --- Initial Setup ---
    async function initPage() { // Make the initialization async
        console.log("Initializing proficiency page...");

        // 1. Setup Header and check auth status FIRST
        await checkAuthAndSetupHeader(); // Wait for auth check (which might redirect)
        setupDropdown(); // Setup dropdown interaction
        if(els.signOutBtn) {
            els.signOutBtn.addEventListener('click', handleSignOut); // Setup signout listener
        }

        // Ensure the rest of the code only runs if the page wasn't redirected
        // A simple check: if the user profile header is not displayed (meaning user logged out/redirected)
        if (els.userProfileHeader && els.userProfileHeader.style.display === 'none' && els.signInLink && els.signInLink.style.display !== 'none') {
            console.log("Halting full page init as user is not logged in or redirected.");
            return; // Stop further initialization if auth failed/redirected
        }

        // 2. Setup core page functionality
        generateLevelSelectorItems();
        setupNativeLanguageSelection();
        await fetchAndPrefillProficiency(); // Fetch data and prefill if exists (now runs after header setup)
        // Update description based on potentially prefilled index OR default (-1)
        updateDescriptionArea(selectedProficiencyIndex);

        // 3. Setup remaining event listeners
        if(els.continueButton) {
            els.continueButton.addEventListener('click', handleContinue);
        }
        window.addEventListener('scroll', () => {
             document.body.classList.toggle('scrolled', window.scrollY > 50);
        }, { passive: true });

        // 4. Apply entrance animations (can run after everything else is set up)
        document.querySelectorAll('.page-header, .native-language-section, .proficiency-section, .continue-button-container').forEach((el, index) => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.style.animation = `fadeInUp 0.6s ease-out ${0.1 + index * 0.1}s forwards`;
        });

        console.log("Proficiency page initialized.");
    }

    window.addEventListener('DOMContentLoaded', initPage); // Call the async init function

  </script>
</body>
</html>
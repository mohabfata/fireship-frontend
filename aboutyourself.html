<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>About Yourself | Fireship English</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- Base Style Variables --- */
     :root {
        --primary-color: #5A8DEE; --secondary-color: #3DDC97; --dark-purple: #4B0082; --accent-color: #FF6347; --success-color: #28a745; --warning-color: #ffc107; --light-color: #ffffff; --bg-light: #f8faff; --bg-section-alt: #f5f8fd; --dark-color: #34495e; --gray-color: #8492a6; --border-color: #eef2f7; --input-bg-color: #f7faff; --border-radius: 16px; --box-shadow: 0 22px 55px rgba(90, 141, 238, 0.18); --box-shadow-light: 0 10px 30px rgba(0, 0, 0, 0.06); --transition-speed: 0.4s; --transition-timing: cubic-bezier(0.4, 0, 0.2, 1); --animation-speed: 0.5s;
    }
    /* --- Base Styles --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; scroll-padding-top: 70px; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-light); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23eaf2ff' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v1 S9 22.5 9 22.5h10v-1.5S23 15 23 15L12.99 7.5zM28 19.09v15l-14 8.08L0 34.09v-15L14 5.91 28 19.09z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); min-height: 100vh; color: var(--dark-color); line-height: 1.7; overflow-x: hidden; padding-top: 70px; }

    /* --- Header Styles --- */
    header.main-header {
        background-color: rgba(255, 255, 255, 0.92); backdrop-filter: blur(14px); box-shadow: none; padding: 0 2rem; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; height: 70px; border-bottom: 1px solid transparent; transition: all var(--transition-speed) ease;
    }
    body.scrolled header.main-header { background-color: rgba(255, 255, 255, 0.97); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06); border-bottom-color: var(--border-color); }
    .header-logo-link { display: flex; align-items: center; text-decoration: none; height: 100%; }
    .header-logo { display: flex; align-items: center; height: 40px; overflow: visible; }
    .header-logo img { height: 80px; margin-right: 0.8rem; transform: translateY(-7px); }
    .header-logo span { font-weight: 700; font-size: 1.3rem; color: var(--primary-color); }
    /* User Profile Header */
    .user-profile-header { display: none; /* Hidden by default */ align-items: center; gap: 12px; position: relative; cursor: pointer; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color); object-fit: cover; background-color: #eee; }
    .user-name-header { font-weight: 600; color: var(--dark-color); max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .notification-dot { width: 10px; height: 10px; background-color: var(--accent-color); border-radius: 50%; position: absolute; top: 0; right: 0; border: 1.5px solid white; display: none; }
    .profile-dropdown { display: none; position: absolute; top: calc(100% + 10px); right: 0; background-color: white; border-radius: var(--border-radius); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid var(--border-color); z-index: 1010; min-width: 200px; overflow: hidden; list-style: none; padding: 8px 0; }
    .profile-dropdown a, .profile-dropdown button { display: flex; align-items: center; width: 100%; text-align: left; padding: 10px 18px; color: var(--dark-color); text-decoration: none; font-size: 0.9rem; font-weight: 500; background: none; border: none; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
    .profile-dropdown a:hover, .profile-dropdown button:hover { background-color: var(--bg-light); color: var(--primary-color); }
    .profile-dropdown a i, .profile-dropdown button i { margin-right: 12px; color: var(--gray-color); transition: color 0.2s ease; width: 16px; text-align: center; }
    .profile-dropdown a:hover i, .profile-dropdown button:hover i { color: var(--primary-color); }
    .dropdown-divider { height: 1px; background-color: var(--border-color); margin: 8px 0; }
    .lessons-link span { flex-grow: 1; }
    .lessons-link .notification-dot { position: static; display: inline-block; margin-left: 8px; width: 8px; height: 8px; vertical-align: middle; background-color: var(--accent-color); border-radius: 50%; border: 1px solid white; visibility: hidden; }
    .lessons-link .notification-dot.visible { visibility: visible; }
    #signInLink { display: none; /* Hidden by default */ color: var(--primary-color); text-decoration: none; font-weight: 600; padding: 8px 18px; border: 2px solid var(--primary-color); border-radius: 50px; transition: all var(--transition-speed) var(--transition-timing); }
    #signInLink:hover { background-color: var(--primary-color); color: white; }

    /* --- Page Content Styles (Keep Existing) --- */
    .page-wrapper { width: 100%; padding: 40px 20px; }
    .content-header { padding: 40px 20px; text-align: center; margin-bottom: 40px; } .titles { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; } .arabic-title { font-family: 'Cairo', sans-serif; font-size: 3.2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s var(--transition-timing) 0.1s forwards; } .english-title { font-size: 1.9rem; font-weight: 600; color: var(--dark-color); letter-spacing: 0.5px; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s var(--transition-timing) 0.2s forwards; } .intro-text { max-width: 750px; margin: 0 auto; font-size: 1.1rem; line-height: 1.8; color: var(--gray-color); opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s var(--transition-timing) 0.3s forwards; }
    .main-content { padding: 0; max-width: 850px; margin: 0 auto; width: 100%; }
    .form-card { background-color: var(--light-color); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); border: 1px solid var(--border-color); opacity: 0; transform: translateY(30px); animation: fadeInUp 0.8s var(--transition-timing) 0.4s forwards; } .form-header { background: linear-gradient(135deg, var(--primary-color) 0%, #81adea 100%); padding: 1.8rem 2.5rem; color: var(--light-color); border-bottom: 1px solid rgba(255, 255, 255, 0.2); } .form-title { font-size: 1.6rem; font-weight: 600; } .form-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 8px; } .form-body { padding: 3rem; }
    .input-group { margin-bottom: 2.2rem; position: relative; } .input-group:last-of-type { margin-bottom: 2.5rem; } .input-label { display: block; margin-bottom: 0.8rem; font-weight: 600; color: var(--dark-color); font-size: 1.05rem; } .input-field, .country-dropdown { width: 100%; padding: 1rem 1.2rem; font-size: 1rem; font-family: 'Poppins', sans-serif; background-color: var(--input-bg-color); border: 1px solid var(--border-color); border-radius: 10px; transition: all var(--transition-speed) var(--transition-timing); color: var(--dark-color); } .input-field::placeholder { color: #aab5c4; } .input-field:focus, .country-dropdown:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 141, 238, 0.15); background-color: var(--light-color); } input[type="date"] { color-scheme: light; } input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; transition: opacity var(--transition-speed); } input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 0.9; }
    .nationality-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 0.5rem; } .nationality-option { position: relative; } .nationality-radio { position: absolute; opacity: 0; width: 0; height: 0; } .nationality-label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.2rem 0.8rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--input-bg-color); cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); height: 100%; } .nationality-label:hover { transform: translateY(-3px); box-shadow: var(--box-shadow-light); border-color: #dce8fa; } .nationality-radio:checked + .nationality-label { border-color: var(--secondary-color); background-color: rgba(61, 220, 151, 0.08); box-shadow: 0 4px 15px rgba(61, 220, 151, 0.15); transform: translateY(-2px); } .nationality-flag { width: 40px; height: 40px; margin-bottom: 1rem; border-radius: 50%; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); } .nationality-label svg.nationality-flag { box-shadow: none; } .nationality-name { font-weight: 500; font-size: 0.9rem; text-align: center; color: var(--dark-color); } .country-dropdown { width: 100%; display: none; margin-top: 1.2rem; }
    .gender-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.5rem; } .gender-option { position: relative; } .gender-radio { position: absolute; opacity: 0; width: 0; height: 0; } .gender-label { display: flex; align-items: center; justify-content: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 10px; background-color: var(--input-bg-color); cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); font-weight: 500; font-size: 1rem; text-align: center; height: 100%; } .gender-label:hover { transform: translateY(-3px); box-shadow: var(--box-shadow-light); border-color: #dce8fa; } .gender-radio:checked + .gender-label { border-color: var(--secondary-color); background-color: rgba(61, 220, 151, 0.08); box-shadow: 0 4px 15px rgba(61, 220, 151, 0.15); transform: translateY(-2px); color: var(--primary-color); font-weight: 600; }
    .submit-btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 1.1rem; background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: var(--light-color); border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all var(--transition-speed) var(--transition-timing); margin-top: 1.5rem; box-shadow: 0 8px 25px rgba(90, 141, 238, 0.25); } .submit-btn:hover:not(:disabled) { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(90, 141, 238, 0.35); filter: brightness(1.1); } .submit-btn:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(90, 141, 238, 0.2); }
    .validation-error { color: var(--accent-color); font-size: 0.9rem; font-weight: 500; margin-top: 0.6rem; display: none; padding-left: 5px; }
    .input-group.error .input-field, .input-group.error .country-dropdown, .input-group.error .nationality-label, .input-group.error .gender-label { border-color: var(--accent-color); }
    .input-group.error .input-field:focus, .input-group.error .country-dropdown:focus { box-shadow: 0 0 0 3px rgba(255, 99, 71, 0.1); } .input-group.error .validation-error { display: block; }
    #submissionFeedback { text-align: center; margin-top: 1rem; font-weight: 500; font-size: 0.95rem; display: none; } #submissionFeedback.success { color: var(--success-color); } #submissionFeedback.error { color: var(--accent-color); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { body { padding-top: 70px; } header.main-header{ height: 70px; padding: 0 1.5rem;} .arabic-title { font-size: 2.8rem; } .english-title { font-size: 1.7rem; } .intro-text { font-size: 1.05rem; } .form-card { margin: 0 10px; } .form-body { padding: 2rem; } .nationality-group { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.8rem; } .nationality-label { padding: 1rem 0.5rem; } .nationality-flag { width: 35px; height: 35px; margin-bottom: 0.8rem; } .gender-options { grid-template-columns: 1fr; } }
    @media (max-width: 480px) { .page-wrapper { padding: 20px 10px; } .content-header { padding: 25px 10px; margin-bottom: 30px;} .arabic-title { font-size: 2.4rem; } .english-title { font-size: 1.5rem; } .intro-text { font-size: 1rem; } .main-content { max-width: 100%; } .form-header { padding: 1.5rem 1.8rem; } .form-title { font-size: 1.4rem; } .form-body { padding: 1.8rem; } .input-group { margin-bottom: 1.8rem; } .input-label { font-size: 1rem; } .input-field, .country-dropdown { padding: 0.9rem 1rem; font-size: 0.95rem; } .nationality-group { grid-template-columns: repeat(2, 1fr); } .gender-label { padding: 0.9rem; font-size: 0.95rem; } .submit-btn { padding: 1rem; font-size: 1.05rem; } }

  </style>
</head>
<body>
  <!-- Header -->
  <header class="main-header">
      <a href="Index.html" class="header-logo-link"> <!-- Logo Link -->
          <div class="header-logo">
              <img src="https://imgur.com/bXjTJAj.png" alt="Fireship Logo">
              <span>Fireship</span>
          </div>
      </a>
      <!-- Sign In Link (Hidden by default on this page) -->
      <a href="welcome.html?source=signIn" id="signInLink" style="display: none;">Sign In</a>
      <!-- User Profile Area -->
      <div class="user-profile-header" id="user-profile-header">
           <span class="user-name-header" id="userNameHeader">User</span>
           <img src="placeholder-avatar.png" alt="User Avatar" class="user-avatar" id="userAvatarHeader">
           <div class="notification-dot" id="notificationDot"></div>
           <div class="profile-dropdown" id="profileDropdown">
               <a href="profile.html"><i class="fas fa-user-circle"></i> My Profile</a>
               <a href="lessons.html" class="lessons-link">
                   <i class="fas fa-calendar-check"></i>
                   <span>My Lessons</span>
                   <span class="notification-dot" id="lessonsNotificationDot"></span>
               </a>
               <div class="dropdown-divider"></div>
               <button id="signOutBtn"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
           </div>
      </div>
    </header>

  <!-- Page Content -->
  <div class="page-wrapper">
    <header class="content-header">
      <div class="titles">
        <h1 class="arabic-title">عن نفسك</h1>
        <h2 class="english-title">Tell Us About Yourself</h2>
      </div>
      <p class="intro-text">
        Welcome! Just a few more details help us personalize your learning journey. Let's get started! (You must be 18 or older).
      </p>
    </header>

    <main class="main-content">
      <div class="form-card">
        <div class="form-header">
          <h3 class="form-title">Your Information</h3>
          <p class="form-subtitle">Help us tailor your experience</p>
        </div>

        <div class="form-body">
          <form id="userInfoForm" novalidate>
            <!-- Name Field -->
            <div class="input-group" id="name-group">
              <label for="name" class="input-label">Full Name</label>
              <input type="text" id="name" name="name" class="input-field" placeholder="Enter your full name" required>
              <div class="validation-error" id="name-error">Please enter your full name</div>
            </div>

            <!-- Nationality Field -->
            <div class="input-group" id="nationality-group">
              <label class="input-label">Nationality</label>
              <div class="nationality-group">
                <div class="nationality-option"> <input type="radio" id="nationality-sa" name="nationality_choice" value="SA" class="nationality-radio" required> <label for="nationality-sa" class="nationality-label"> <img src="https://flagcdn.com/w80/sa.png" alt="Saudi Arabia flag" class="nationality-flag"> <span class="nationality-name">Saudi Arabia</span> </label> </div>
                <div class="nationality-option"> <input type="radio" id="nationality-qa" name="nationality_choice" value="QA" class="nationality-radio"> <label for="nationality-qa" class="nationality-label"> <img src="https://flagcdn.com/w80/qa.png" alt="Qatar flag" class="nationality-flag"> <span class="nationality-name">Qatar</span> </label> </div>
                <div class="nationality-option"> <input type="radio" id="nationality-ae" name="nationality_choice" value="AE" class="nationality-radio"> <label for="nationality-ae" class="nationality-label"> <img src="https://flagcdn.com/w80/ae.png" alt="UAE flag" class="nationality-flag"> <span class="nationality-name">UAE</span> </label> </div>
                <div class="nationality-option"> <input type="radio" id="nationality-bh" name="nationality_choice" value="BH" class="nationality-radio"> <label for="nationality-bh" class="nationality-label"> <img src="https://flagcdn.com/w80/bh.png" alt="Bahrain flag" class="nationality-flag"> <span class="nationality-name">Bahrain</span> </label> </div>
                 <div class="nationality-option"> <input type="radio" id="nationality-kw" name="nationality_choice" value="KW" class="nationality-radio"> <label for="nationality-kw" class="nationality-label"> <img src="https://flagcdn.com/w80/kw.png" alt="Kuwait flag" class="nationality-flag"> <span class="nationality-name">Kuwait</span> </label> </div>
                <div class="nationality-option"> <input type="radio" id="nationality-other" name="nationality_choice" value="other" class="nationality-radio"> <label for="nationality-other" class="nationality-label"> <svg class="nationality-flag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 40px; height: 40px; color: var(--gray-color);"> <circle cx="12" cy="12" r="10" /> <line x1="12" y1="8" x2="12" y2="16" /> <line x1="8" y1="12" x2="16" y2="12" /> </svg> <span class="nationality-name">Other</span> </label> </div>
              </div>
              <select id="country-dropdown" name="country" class="input-field country-dropdown">
                  <option value="" disabled selected>Please select your country</option>
                   <option value="AF">Afghanistan</option><option value="AL">Albania</option><option value="DZ">Algeria</option><option value="AD">Andorra</option> <option value="AR">Argentina</option> <!-- ... other countries ... --> <option value="ZW">Zimbabwe</option>
              </select>
              <div class="validation-error" id="nationality-error">Please select your nationality</div>
            </div>

            <!-- Date of Birth Field -->
            <div class="input-group" id="dob-group">
              <label for="dob" class="input-label">Date of Birth</label>
              <input type="date" id="dob" name="dob" class="input-field" required max=" ">
              <div class="validation-error" id="dob-error">Please enter a valid date of birth (must be 18+)</div>
            </div>

            <!-- Gender Selection -->
            <div class="input-group" id="gender-group">
              <label class="input-label">Gender</label>
              <div class="gender-options">
                <div class="gender-option"> <input type="radio" id="gender-male" name="gender" value="male" class="gender-radio" required> <label for="gender-male" class="gender-label">Male</label> </div>
                <div class="gender-option"> <input type="radio" id="gender-female" name="gender" value="female" class="gender-radio"> <label for="gender-female" class="gender-label">Female</label> </div>
                <div class="gender-option"> <input type="radio" id="gender-other" name="gender" value="prefer_not" class="gender-radio"> <label for="gender-other" class="gender-label">Prefer not to say</label> </div>
              </div>
              <div class="validation-error" id="gender-error">Please select your gender</div>
            </div>

            <!-- Submission Feedback Area -->
            <div id="submissionFeedback"></div>

            <!-- Submit Button -->
            <button type="submit" id="submitButton" class="submit-btn">
                <span class="btn-text">Continue</span>
                <i class="fas fa-spinner fa-spin btn-loader" style="display: none;"></i>
                <i class="fas fa-arrow-right btn-icon" style="font-size: 0.9em; margin-left: 5px;"></i>
            </button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScript -->
  <script>
      // --- DOM Elements ---
    // Form elements
    function getElement(id) { const el = document.getElementById(id); if (!el) console.error(`DOM Element ID "${id}" not found!`); return el; } // Define helper first
    const form = getElement('userInfoForm');
    const nameInput = getElement('name');
    const dobInput = getElement('dob');
    const nationalityRadios = document.querySelectorAll('input[name="nationality_choice"]');
    const genderRadios = document.querySelectorAll('input[name="gender"]');
    const otherRadio = getElement('nationality-other');
    const countryDropdown = getElement('country-dropdown');
    const submitButton = getElement('submitButton');
    const submissionFeedback = getElement('submissionFeedback');
    const nameGroup = getElement('name-group');
    const nationalityGroup = getElement('nationality-group');
    const dobGroup = getElement('dob-group');
    const genderGroup = getElement('gender-group');
    // Header elements
    const signInLink = getElement('signInLink');
    const userProfileHeader = getElement('user-profile-header');
    const userNameHeader = getElement('userNameHeader');
    const userAvatarHeader = getElement('userAvatarHeader');
    const profileDropdown = getElement('profileDropdown');
    const signOutBtn = getElement('signOutBtn');
    const notificationDot = getElement('notificationDot');
    const lessonsNotificationDot = getElement('lessonsNotificationDot');

    // --- Configuration ---
    const API_BASE_URL = 'https://api.fireship.org'; // <-- YOUR LIVE API DOMAIN

    // --- Utility Functions ---
    async function apiRequest(url, options) {
        const fullUrl = url.startsWith('/') ? `${API_BASE_URL}${url}` : url;
        console.debug(`API Req: ${options?.method || 'GET'} ${fullUrl}`);
        try {
            const r = await fetch(fullUrl, options);
            if (!r.ok) {
                let m = `API Error (${r.status})`; let d=null;
                try { d=await r.json(); m=d.message||m;} catch (e) {}
                console.error(`API Fail: ${r.status} ${r.statusText} @ ${fullUrl}`, d);
                if(r.status===401){ console.warn("API 401 -> Welcome"); window.location.href='welcome.html'; return null; }
                throw new Error(d?.message || `Request failed: ${r.status}`);
            }
            const ct = r.headers.get("content-type");
            if (ct?.includes("application/json")) {
                const d = await r.json(); console.debug(`API OK JSON @ ${fullUrl}:`, d); return d;
            } else { console.debug(`API OK NoJSON @ ${fullUrl}`); return {}; }
        } catch (e) {
            console.error(`API Excep (${fullUrl}):`, e);
            if (e.message.toLowerCase().includes('failed to fetch')) throw new Error("Network error.");
            throw e;
        }
    }
    function showButtonLoading(b, l) { if(!b)return; const t=b.querySelector('.btn-text'); const o=b.querySelector('.btn-loader'); b.disabled=l; b.classList.toggle('loading',l); if(t)t.style.display=l?'none':'inline'; if(o)o.style.display=l?'inline-block':'none'; if(b.querySelector('.btn-icon')) b.querySelector('.btn-icon').style.display = l ? 'none' : 'inline-block'; }
    function showLoading(isLoading) { showButtonLoading(submitButton, isLoading); }
    function showFeedback(m, e=false) { if (!submissionFeedback) return; submissionFeedback.textContent = m; submissionFeedback.className = e ? 'error' : 'success'; submissionFeedback.style.display = 'block'; }
    function clearFeedback() { if (!submissionFeedback) return; submissionFeedback.textContent = ''; submissionFeedback.style.display = 'none'; }

    // --- Header Logic ---
    function updateHeaderUI(userData, hasBooking) { if (userData && userProfileHeader && userNameHeader && userAvatarHeader && signInLink) { signInLink.style.display = 'none'; userProfileHeader.style.display = 'flex'; userNameHeader.textContent = userData.name || 'User'; userAvatarHeader.src = userData.avatarUrl || 'placeholder-avatar.png'; userAvatarHeader.onerror = () => { userAvatarHeader.src = 'placeholder-avatar.png'; }; if (notificationDot) notificationDot.style.display = hasBooking ? 'block' : 'none'; if (lessonsNotificationDot) lessonsNotificationDot.classList.toggle('visible', hasBooking); } else if (signInLink && userProfileHeader) { signInLink.style.display = 'block'; userProfileHeader.style.display = 'none'; if (notificationDot) notificationDot.style.display = 'none'; if (lessonsNotificationDot) lessonsNotificationDot.classList.remove('visible'); } }
    function setupDropdown() { const profileArea = userProfileHeader; if (profileArea && profileDropdown) { profileArea.addEventListener('click', (event) => { event.stopPropagation(); profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block'; }); window.addEventListener('click', (event) => { if (profileDropdown?.style.display === 'block' && !profileArea.contains(event.target)) { profileDropdown.style.display = 'none'; } }); } }
    async function handleSignOut() { console.log("Signing out..."); try { await apiRequest('/api/auth/logout', { method: 'POST' }); window.location.href = 'welcome.html'; } catch (error) { console.error("Sign out failed:", error); alert(`Sign out failed: ${error.message}`); } }
    async function checkAuthAndSetupHeader() { console.log("[Header Auth Check] Checking..."); try { const status = await apiRequest('/api/user/status', { method: 'GET' }); if (status && status.user) { updateHeaderUI(status.user, status.hasBooking || false); } else { updateHeaderUI(null, false); } } catch (error) { console.warn("[Header Auth Check] Failed:", error.message); updateHeaderUI(null, false); } }

    // --- Form Logic ---
    async function fetchAndPrefillData() { console.log("[Prefill] Fetching about data..."); try { const userData = await apiRequest('/api/user/profile/about', { method: 'GET' }); if (userData === null) return; console.log("[Prefill] Fetched:", userData); if (userData && Object.keys(userData).length > 0) { if (userData.name && nameInput) nameInput.value = userData.name; if (userData.dob && /^\d{4}-\d{2}-\d{2}$/.test(userData.dob) && dobInput) dobInput.value = userData.dob; if (userData.gender) { const gi = document.querySelector(`input[name="gender"][value="${userData.gender}"]`); if(gi) gi.checked = true; } if (userData.nationality_choice) { const nc = userData.nationality_choice; const cv = userData.country; const ni = document.querySelector(`input[name="nationality_choice"][value="${nc}"]`); if (ni) { ni.checked = true; const isOther = (nc === 'other'); toggleCountryDropdown(isOther); if (isOther && cv && countryDropdown) countryDropdown.value = cv; } else { toggleCountryDropdown(false); } } else { toggleCountryDropdown(false); } console.log("[Prefill] Complete."); } else { console.log("[Prefill] No data found."); toggleCountryDropdown(false); } } catch (error) { console.warn("[Prefill] Fetch failed:", error.message); toggleCountryDropdown(false); } }
    function toggleCountryDropdown(show) { if (!countryDropdown) return; countryDropdown.style.display = show ? 'block' : 'none'; countryDropdown.required = show; countryDropdown.disabled = !show; if (!show) countryDropdown.value = ""; }
    function showError(groupEl, errId, msg) { if(groupEl) groupEl.classList.add('error'); const errEl = getElement(errId); if(errEl) { errEl.textContent = msg; errEl.style.display = 'block'; } }
    function clearError(groupEl) { if (groupEl) { groupEl.classList.remove('error'); const errEl = groupEl.querySelector('.validation-error'); if(errEl) errEl.style.display = 'none'; } }
    function validateForm() { console.log("Validating form..."); let isValid = true; clearError(nameGroup); clearError(nationalityGroup); clearError(dobGroup); clearError(genderGroup); if (!nameInput || nameInput.value.trim() === '') { showError(nameGroup, 'name-error', 'Please enter your full name'); isValid = false; } const selectedNat = document.querySelector('input[name="nationality_choice"]:checked'); if (!selectedNat) { showError(nationalityGroup, 'nationality-error', 'Please select nationality'); isValid = false; } else if (selectedNat.value === 'other') { if (!countryDropdown || !countryDropdown.value) { showError(nationalityGroup, 'nationality-error', 'Please select country'); isValid = false; } } if (!dobInput || !dobInput.value) { showError(dobGroup, 'dob-error', 'Please enter date of birth'); isValid = false; } else { try { const dob = new Date(dobInput.value); if (isNaN(dob.getTime())) throw new Error("Invalid"); const today = new Date(); today.setHours(0,0,0,0); if (dob > today) { showError(dobGroup, 'dob-error', 'Date cannot be in future'); isValid = false; } else { const cutoff = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate()); if (dob > cutoff) { showError(dobGroup, 'dob-error', 'Must be 18+'); isValid = false; } } } catch (e) { showError(dobGroup, 'dob-error', 'Invalid date format'); isValid = false; } } if (!document.querySelector('input[name="gender"]:checked')) { showError(genderGroup, 'gender-error', 'Please select gender'); isValid = false; } console.log("Validation result:", isValid); return isValid; }
    function setupFormHandlers() { if (!form) { console.error("Form not found!"); return; } nationalityRadios.forEach(radio => { radio.addEventListener('change', () => { if(otherRadio) toggleCountryDropdown(otherRadio.checked); clearError(nationalityGroup); }); }); if(nameInput) nameInput.addEventListener('input', () => clearError(nameGroup)); if(dobInput) dobInput.addEventListener('input', () => clearError(dobGroup)); if(countryDropdown) countryDropdown.addEventListener('change', () => clearError(nationalityGroup)); genderRadios.forEach(radio => radio.addEventListener('change', () => clearError(genderGroup))); form.addEventListener('submit', async function(e) { e.preventDefault(); console.log("Form submit triggered."); clearFeedback(); if (validateForm()) { console.log("Form valid, submitting..."); showLoading(true); const selectedNatRadio = document.querySelector('input[name="nationality_choice"]:checked'); const selectedGenRadio = document.querySelector('input[name="gender"]:checked'); const natChoice = selectedNatRadio ? selectedNatRadio.value : null; const formData = { name: nameInput.value.trim(), nationality_choice: natChoice, country: (natChoice === 'other' && countryDropdown) ? countryDropdown.value : null, dob: dobInput.value, gender: selectedGenRadio ? selectedGenRadio.value : null }; console.log('Submitting:', JSON.stringify(formData)); try { const result = await apiRequest('/api/user/profile/about', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) }); if (result === null) return; console.log("Submit success:", result); window.location.href = "learningstyle.html"; } catch (error) { console.error("Submit failed:", error); showFeedback(`Error: ${error.message}`, true); showLoading(false); } } else { console.log("Form invalid."); showFeedback("Please fix errors.", true); const firstError = form.querySelector('.input-group.error'); if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }); }

    // --- Initial Page Setup ---
    window.addEventListener('DOMContentLoaded', async function() {
        console.log("AboutYou Page DOM Loaded");
        setDobMaxDate();
        setupDropdown(); // Setup profile dropdown listener
        if(signOutBtn) signOutBtn.addEventListener('click', handleSignOut); // Setup signout
        setupFormHandlers(); // Setup form validation and submission
        await checkAuthAndSetupHeader(); // Check login status and update header FIRST
        await fetchAndPrefillData(); // Load existing user data AFTER checking auth
        setupHeaderScroll();
        applyEntranceAnimations();
    });

    // --- Helper Functions ---
    function setDobMaxDate() { if (dobInput) { const today = new Date(); const y = today.getFullYear() - 18; const m = String(today.getMonth() + 1).padStart(2, '0'); const d = String(today.getDate()).padStart(2, '0'); dobInput.max = `${y}-${m}-${d}`; console.log("Set DOB max date:", dobInput.max); } }
    function setupHeaderScroll() { window.addEventListener('scroll', () => { document.body.classList.toggle('scrolled', window.scrollY > 30); }, { passive: true }); }
    function applyEntranceAnimations() { document.querySelectorAll('.content-header > *, .form-card').forEach((el, i) => { el.style.opacity='0'; el.style.transform='translateY(20px)'; el.style.animation=`fadeInUp 0.6s ease-out ${0.1 + i * 0.1}s forwards`; }); }
    // getElement defined earlier

</script>
</body>
</html>
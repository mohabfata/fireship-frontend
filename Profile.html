  <script>
    // --- DOM Elements ---
    const profileNameEl = getElement('profile-name');
    const profileEmailEl = getElement('profile-email');
    const profileAvatarEl = getElement('profile-avatar'); // Main profile avatar
    const profileDobEl = getElement('profile-dob');
    const profileGenderEl = getElement('profile-gender');
    const profileNationalityEl = getElement('profile-nationality');
    const profileNativeLangEl = getElement('profile-native-language');
    const profileProficiencyEl = getElement('profile-proficiency');
    const profileLearningPathEl = getElement('profile-learning-path');
    const lessonsListContainer = getElement('lessons-list');
    const emptyStateDiv = getElement('empty-state');
    const errorStateDiv = getElement('error-state');
    const loadingSpinner = getElement('loadingSpinner');
    // Header Elements
    const signInLink = getElement('signInLink');
    const userProfileHeader = getElement('user-profile-header');
    const userNameHeader = getElement('userNameHeader');
    const userAvatarHeader = getElement('userAvatarHeader'); // *** Header avatar ***
    const profileDropdown = getElement('profileDropdown');
    const signOutBtn = getElement('signOutBtn');
    const notificationDot = getElement('notificationDot');
    const lessonsNotificationDot = getElement('lessonsNotificationDot');

    // --- Utilities & Lesson Logic ---

    // Add this line BEFORE the apiRequest function definition
    const API_BASE_URL = 'https://api.fireship.org'; // <-- YOUR LIVE API URL

    async function apiRequest(url, options = {}) { // Default options to {}
         const fullUrl = url.startsWith('/') ? API_BASE_URL + url : url; // Use constant

         // Create opts object including credentials
         const opts = {
             credentials: 'include', // <-- Add credentials: 'include'
             ...options, // Merge other passed options
         };

         console.debug(`API Req: ${opts.method || 'GET'} ${fullUrl}`); // Log method and fullUrl

         try {
             // Use fullUrl and opts in the fetch call
             const r = await fetch(fullUrl, opts);

             if (!r.ok) {
                 let errorMsg = `API Error (${r.status})`;
                 let errorData = null;
                 try { errorData = await r.json(); errorMsg = errorData.message || errorMsg; } catch (e) { /* ignore */ }
                 console.error(`API Fail: ${r.status} ${r.statusText} @ ${fullUrl}`, errorData);

                 // Specific 401 handling for profile page (redirect to welcome)
                 if (r.status === 401) {
                     console.warn("[apiRequest] API 401 Unauthorized -> Redirecting to welcome");
                     window.location.href = 'welcome.html';
                     return null; // Signal redirect
                 }
                 throw new Error(errorData?.message || `Request failed: ${r.status}`);
             }

             const ct = r.headers.get("content-type");
             if (ct?.includes("application/json")) {
                 const d = await r.json();
                 console.debug(`API OK JSON @ ${fullUrl}:`, d);
                 return d;
             } else {
                 console.debug(`API OK NoJSON @ ${fullUrl} (${r.status})`);
                 return {}; // Return empty object for non-JSON OK responses
             }
         } catch (e) {
              console.error(`API Excep (${fullUrl}):`, e);
              if (e.message.toLowerCase().includes('failed to fetch')) {
                  throw new Error("Network error.");
              }
              throw e;
         }
    }


    function showLoadingState(isLoading) { if (loadingSpinner) loadingSpinner.style.display = isLoading ? 'block' : 'none'; if (!isLoading) { if (emptyStateDiv) emptyStateDiv.style.display = 'none'; if (errorStateDiv) errorStateDiv.style.display = 'none'; } }
    function displayLessons(lessons) { if (!lessonsListContainer) return; lessonsListContainer.querySelectorAll('.lesson-card').forEach(card => card.remove()); if (lessons?.length > 0) { if (emptyStateDiv) emptyStateDiv.style.display = 'none'; if (errorStateDiv) errorStateDiv.style.display = 'none'; lessons.sort((a, b) => new Date(a.utcStartTime) - new Date(b.utcStartTime)); lessons.forEach((lesson, index) => { const lessonCard = createLessonCardElement(lesson); lessonCard.style.animationDelay = `${index * 0.05}s`; lessonsListContainer.appendChild(lessonCard); }); } else { if (emptyStateDiv) emptyStateDiv.style.display = 'block'; if (errorStateDiv) errorStateDiv.style.display = 'none'; } }
    function displayErrorState(isProfileError = false) {
        if (!errorStateDiv) return;
        if(lessonsListContainer) lessonsListContainer.querySelectorAll('.lesson-card').forEach(card => card.remove());
        if (emptyStateDiv) emptyStateDiv.style.display = 'none';
        const errorMsgElement = errorStateDiv.querySelector('p');
        if(errorMsgElement) {
            errorMsgElement.textContent = isProfileError ? "Error fetching profile data. Please refresh." : "Error fetching lessons. Please refresh.";
        }
        errorStateDiv.style.display = 'block';
    }
    function createLessonCardElement(lesson) { const card = document.createElement('div'); card.className = 'lesson-card animate-in'; card.dataset.lessonId = lesson.id; const startTime = new Date(lesson.utcStartTime); const endTime = new Date(startTime.getTime() + (lesson.durationMinutes || 20) * 60 * 1000); const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; const timeOptions = { hour: 'numeric', minute: '2-digit', timeZoneName: 'short' }; const formattedDate = startTime.toLocaleDateString(undefined, dateOptions); const formattedStartTime = startTime.toLocaleTimeString(undefined, timeOptions); const formattedEndTime = endTime.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' }); card.innerHTML = `<div class="lesson-details"><h3>${lesson.title || 'Personalized Session'}</h3><p><i class="far fa-calendar-alt"></i> ${formattedDate}</p><p><i class="far fa-clock"></i> ${formattedStartTime} - ${formattedEndTime}</p><div class="teacher"><img class="teacher-avatar" src="${lesson.instructor?.avatarUrl || 'placeholder-avatar.png'}" alt="Teacher" onerror="this.onerror=null; this.src='placeholder-avatar.png';"><span>${lesson.instructor?.name || 'To be decided'}</span></div></div><div class="lesson-actions"><button class="btn" onclick="rescheduleLesson('${lesson.id}')"><i class="fas fa-edit"></i> Reschedule</button><a href="confirmation.html?lessonId=${lesson.id}" class="btn btn-secondary"><i class="fas fa-video"></i> Join/View</a><button class="btn btn-danger" onclick="cancelLesson('${lesson.id}')"><i class="fas fa-times-circle"></i> Cancel</button></div>`; return card; }
    function rescheduleLesson(lessonId) { console.log("Reschedule lesson:", lessonId); alert(`Rescheduling requires integration.`); }
    async function cancelLesson(lessonId) { console.log("Cancel lesson:", lessonId); if (confirm(`Are you sure you want to cancel lesson ${lessonId}? This action cannot be undone.`)) { alert(`Cancellation requires backend integration.`); /* Add backend call here */ } }

    // --- Header Logic ---
    function updateHeaderUI(userData, hasBooking) {
        console.log("[updateHeaderUI] Updating header. UserData:", userData, "HasBooking:", hasBooking); // Log input
        // *** FIX: Use userAvatarHeader (ID from HTML) ***
        const userAvatarHeaderEl = userAvatarHeader; // Use the already defined const

        if (userData && userProfileHeader && userNameHeader && userAvatarHeaderEl && signInLink) {
            signInLink.style.display = 'none';
            userProfileHeader.style.display = 'flex';
            userNameHeader.textContent = userData.name || 'User';
            // *** FIX: Use avatar_url for header avatar consistency ***
            userAvatarHeaderEl.src = userData.avatar_url || 'placeholder-avatar.png';
            userAvatarHeaderEl.onerror = () => {
                console.warn("[updateHeaderUI] Header avatar failed to load, using placeholder.");
                if (userAvatarHeaderEl) userAvatarHeaderEl.src = 'placeholder-avatar.png';
            };
            if (notificationDot) notificationDot.style.display = hasBooking ? 'block' : 'none';
            if (lessonsNotificationDot) lessonsNotificationDot.classList.toggle('visible', hasBooking);
            console.log("[updateHeaderUI] Displaying logged-in state.");
        } else if (signInLink && userProfileHeader) {
            signInLink.style.display = 'block';
            userProfileHeader.style.display = 'none';
            if (notificationDot) notificationDot.style.display = 'none';
            if (lessonsNotificationDot) lessonsNotificationDot.classList.remove('visible');
            console.log("[updateHeaderUI] Displaying logged-out state.");
        } else {
            console.error("[updateHeaderUI] Header elements missing!");
        }
    }

    function setupDropdown() { const profileArea = userProfileHeader; if (profileArea && profileDropdown) { profileArea.addEventListener('click', (event) => { event.stopPropagation(); profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block'; }); window.addEventListener('click', (event) => { if (profileDropdown.style.display === 'block' && !profileArea.contains(event.target)) { profileDropdown.style.display = 'none'; } }); } }
    async function handleSignOut() {
        console.log("Signing out...");
        try {
            // Use updated apiRequest
            const result = await apiRequest('/api/auth/logout', { method: 'POST' });
            if (result === null) return; // Redirect happened
            window.location.href = 'welcome.html';
        } catch (error) {
            console.error("Sign out failed:", error);
            if (error.message !== "Redirecting") {
                alert(`Sign out failed: ${error.message}`);
            }
        }
    }
    // Strengthened Auth Check for Profile Page
    async function checkAuthAndSetupHeader() {
        console.log("[Profile Header Auth Check] Checking...");
        let status = null;
        try {
            // Use updated apiRequest
            status = await apiRequest('/api/user/status', { method: 'GET' });

            if (status && status.user) { // Check specifically for user object
                console.log("[Profile Header Auth Check] User logged in:", status.user);
                // *** Crucial: Pass status.user (which contains avatar_url) to updateHeaderUI ***
                updateHeaderUI(status.user, status.hasBooking || false);
                return true; // Auth OK
            } else {
                // Handle cases where status is returned but no user (e.g., session exists but user deleted?)
                // OR where apiRequest returned null (already redirected by 401 handler)
                throw new Error("User not authenticated or status check failed.");
            }
        } catch (error) {
             // Any error during status check on profile page means user is not properly authenticated
            console.warn("[Profile Header Auth Check] Failed:", error.message);
            updateHeaderUI(null, false); // Show Sign In link just in case redirect fails
             console.error("Auth check failed. Redirecting to welcome.");
             window.location.href = 'welcome.html'; // Force redirect
             return false; // Auth failed
        }
    }

    // --- Populate Profile Details (More Robust) ---
    function populateProfileDetails(profileData) {
        console.log("[Populate] Received profile data:", profileData); // Log received data
        // Default values for error/loading state
        const defaultVal = '--';
        const nameDefault = 'Name Not Found'; // More specific default
        const emailDefault = 'Email Not Found'; // More specific default

        // --- Helper to update element text and placeholder class ---
        function updateDetail(element, value, placeholderValue = defaultVal) {
            if (element) {
                const displayValue = (value !== null && value !== undefined && value !== '') ? value : placeholderValue;
                element.textContent = displayValue;
                // Add placeholder class only if the value is actually missing or empty
                element.classList.toggle('placeholder', (value === null || value === undefined || value === ''));
            } else {
                 // console.warn(`[Populate] Element reference is null for value: ${value}`);
            }
        }

        // --- Update Profile Header (Main Profile Avatar) ---
        if (profileAvatarEl) {
             // Use avatar_url (matching backend likely)
            profileAvatarEl.src = profileData?.avatar_url || 'placeholder-avatar.png';
            profileAvatarEl.onerror = () => {
                console.warn("[Populate] Main profile avatar failed to load, using placeholder.");
                profileAvatarEl.src = 'placeholder-avatar.png';
            };
        }

        // --- Update Text Details ---
        updateDetail(profileNameEl, profileData?.name, nameDefault);
        updateDetail(profileEmailEl, profileData?.email, emailDefault);

        // --- Update Account Details ---
        let dobDisplay = defaultVal;
        const rawDob = profileData?.dob; // Get the raw value
        console.log(`[Populate] Raw DOB received: ${rawDob}`); // Log the raw value
        if (rawDob) {
            try {
                 if (/^\d{4}-\d{2}-\d{2}/.test(rawDob)) { // Allow YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS...
                     const datePart = rawDob.substring(0, 10);
                     const utcDate = new Date(datePart + 'T00:00:00Z');
                     console.log(`[Populate] Parsed DOB as Date object: ${utcDate}`);
                     if (!isNaN(utcDate.getTime())) {
                         dobDisplay = utcDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                         console.log("[Populate] Formatted DOB:", dobDisplay);
                     } else { console.warn("[Populate] Invalid date parsed from DOB:", rawDob); }
                 } else { console.warn("[Populate] DOB format not YYYY-MM-DD:", rawDob); }
            } catch (e) { console.error("[Populate] Error formatting DOB:", e); }
        }
        updateDetail(profileDobEl, dobDisplay, defaultVal);

        // Gender (Capitalize first letter)
        updateDetail(profileGenderEl, profileData?.gender ? profileData.gender.charAt(0).toUpperCase() + profileData.gender.slice(1) : null, defaultVal);

        // Nationality (Handle 'other')
        let natDisplay = defaultVal;
        if (profileData?.nationality_choice) {
            natDisplay = profileData.nationality_choice === 'other' && profileData.country
                ? `Other (${profileData.country})`
                : profileData.nationality_choice;
        }
        updateDetail(profileNationalityEl, natDisplay, defaultVal);

        // Native Language (Capitalize first letter)
        updateDetail(profileNativeLangEl, profileData?.native_language ? profileData.native_language.charAt(0).toUpperCase() + profileData.native_language.slice(1) : null, defaultVal);


        // --- Update Learning Preferences ---
        // Proficiency Level (Use alias 'level')
        updateDetail(profileProficiencyEl, profileData?.level, defaultVal);

        // Learning Path (Use aliases 'step1', 'step2', 'step3')
        let pathDisplay = defaultVal;
        if (profileData?.step1 && profileData?.step2 && profileData?.step3) {
            pathDisplay = `${profileData.step1} > ${profileData.step2} > ${profileData.step3}`;
        }
        updateDetail(profileLearningPathEl, pathDisplay, defaultVal);
    }


    // --- Data Fetching for Profile Page ---
    async function fetchProfilePageData() {
        console.log("[Fetch] Starting profile page data fetch sequence.");
        showLoadingState(true);
        let profileData = null;
        let lessonsData = null;

        try {
            // 1. Check Auth and Setup Header
            console.log("[Fetch] Checking authentication...");
            const isAuthOk = await checkAuthAndSetupHeader(); // This now also updates the header UI on success
            if (!isAuthOk) {
                 console.log("[Fetch] Auth check failed or redirected. Halting data fetch.");
                 showLoadingState(false);
                 return;
            }
            console.log("[Fetch] Auth check successful.");

            // 2. Fetch Profile Data
            console.log("[Fetch] Fetching profile data...");
            profileData = await apiRequest('/api/user/profile/all', { method: 'GET' });
            if (profileData === null) throw new Error("Profile data fetch failed or redirected.");
            console.log("[Fetch] Profile data received successfully.");
            populateProfileDetails(profileData); // Populate main profile sections

            // 3. Fetch Lessons Data
            console.log("[Fetch] Fetching lessons data...");
            lessonsData = await apiRequest('/api/user/lessons', { method: 'GET' });
             if (lessonsData === null) throw new Error("Lessons fetch failed or redirected.");
            const lessons = Array.isArray(lessonsData?.lessons) ? lessonsData.lessons : [];
            console.log("[Fetch] Lessons data received successfully.");
            displayLessons(lessons); // Display lessons

            console.log("[Fetch] All data fetched and displayed successfully.");

        } catch (error) {
            console.error("[Fetch] Error during profile page data fetch:", error.message);
            // Error handling logic remains the same
            if (window.location.pathname.includes('profile.html')) {
                if (!profileData) {
                    displayErrorState(true);
                    populateProfileDetails(null);
                } else if (!lessonsData) {
                    displayErrorState(false);
                } else {
                    displayErrorState(true);
                }
            }
        } finally {
            console.log("[Fetch] Finalizing fetch sequence, hiding loading state.");
            showLoadingState(false);
        }
    }

    // --- Initialization ---
     window.addEventListener('DOMContentLoaded', function() {
        console.log("Profile Page DOM Loaded");
        fetchProfilePageData(); // Fetch profile and lessons (uses updated apiRequest)
        setupDropdown(); // Setup dropdown click listener
        if(signOutBtn) {
             signOutBtn.addEventListener('click', handleSignOut); // Setup signout listener
        }
        // Scroll listener for header style change
        window.addEventListener('scroll', function() {
            document.body.classList.toggle('scrolled', window.scrollY > 50);
        }, { passive: true });
     });

     // Helper function
     function getElement(id) {
         const el = document.getElementById(id);
         if (!el) console.error(`Element with ID "${id}" not found.`);
         return el;
     }

  </script>
</body>
</html>
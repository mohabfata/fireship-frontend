<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome | Fireship English Lessons</title>
  <!-- Google Sign-In API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- STYLES (Keep Existing Styles) --- */
    :root {
      --primary-color: #4361ee;
      --accent-color: #3a0ca3;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --success-color: #4cc9f0; /* Success messages/buttons */
      --danger-color: #f72585; /* Error messages */
      --border-radius: 8px;
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --transition-speed: 0.3s;
      --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--light-color); min-height: 100vh; color: var(--dark-color); padding: 0; margin: 0; }
    /* Header Styles */
    header { background-color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 0.75rem 2rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .header-logo { display: flex; align-items: center; height: 32px; overflow: visible; }
    .header-logo img { height: 64px; margin-right: 0.75rem; transform: translateY(-4px); }
    .header-logo span { font-weight: 600; font-size: 1.2rem; color: var(--primary-color); }
    /* Main Content */
    .main-container { display: flex; justify-content: center; align-items: center; padding: 40px 20px; min-height: calc(100vh - 60px); }
    .welcome-container { display: flex; max-width: 900px; width: 100%; background-color: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); }
    /* Image section */
    .image-section { flex: 1 1 45%; background: url('https://images.unsplash.com/photo-1488190211105-8b0e65b80b4e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80') center/cover no-repeat; min-height: 500px; display: none; }
    /* Content section */
    .content-section { flex: 1 1 55%; padding: 3rem 2.5rem; display: flex; flex-direction: column; justify-content: center; }
    h1 { font-size: 2rem; margin-bottom: 1rem; color: var(--dark-color); line-height: 1.3; font-weight: 600; }
    p { color: #6c757d; margin-bottom: 2rem; line-height: 1.7; font-size: 1rem; }
    .features { margin-bottom: 2.5rem; }
    .feature { display: flex; align-items: center; margin-bottom: 1.2rem; }
    .feature-icon { color: var(--primary-color); width: 24px; height: 24px; margin-right: 1rem; font-size: 1.2rem; text-align: center; }
    .feature-text { font-size: 0.95rem; font-weight: 500; color: var(--dark-color); }
    /* CTA Section */
    .cta-section { margin-top: 2rem; text-align: center; }
    #login-prompt { font-size: 1rem; font-weight: 500; color: var(--dark-color); margin-bottom: 1.5rem; }
    .google-btn-wrapper { display: inline-block; position: relative; /* For error message positioning */ }
    /* Continue Button Section */
    #continue-section { display: none; margin-top: 2rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 28px; border-radius: 50px; font-weight: 600; transition: all var(--transition-speed) var(--transition-timing); cursor: pointer; font-size: 1rem; text-decoration: none; border: 2px solid transparent; }
    .btn-primary { background: linear-gradient(90deg, var(--primary-color), var(--success-color)); border-color: transparent; color: white; box-shadow: 0 6px 20px rgba(67, 97, 238, 0.25); }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(67, 97, 238, 0.35); filter: brightness(1.1); }
    .btn i { font-size: 0.9em; margin-left: 8px; }
    /* Error Message Style */
    #auth-error-message {
        display: none; /* Hidden by default */
        color: var(--danger-color);
        font-weight: 500;
        font-size: 0.9rem;
        margin-top: 1rem;
        text-align: center;
    }

    /* Responsive adjustments */
    @media (min-width: 768px) { .image-section { display: block; } .content-section { padding: 4rem 3rem; } h1 { font-size: 2.2rem; } }
    @media (max-width: 480px) { .content-section { padding: 2rem 1.5rem; } h1 { font-size: 1.8rem; } p { font-size: 0.95rem; } .feature-text { font-size: 0.9rem; } .btn { padding: 14px 24px; } .google-btn-wrapper { width: 100%; } .g_id_signin { display: flex !important; justify-content: center; } }

  </style>
</head>
<body>
  <!-- Header Section - Static Content -->
  <header>
    <div class="header-logo">
      <img src="https://imgur.com/bXjTJAj.png" alt="Fireship Logo">
      <span>Fireship</span>
    </div>
  </header>

  <!-- Main Content Section -->
  <div class="main-container">
    <div class="welcome-container">
      <div class="image-section"></div>
      <div class="content-section">
        <h1>Master English with Personalized 1-on-1 Lessons</h1>
        <p>Unlock your potential with expert tutors. Our lessons adapt to your unique learning style and goals, starting with a 100% free trial session!</p>
        <div class="features">
          <div class="feature"> <div class="feature-icon"><i class="fas fa-user-tie"></i></div> <div class="feature-text">Native-speaking certified tutors</div> </div>
          <div class="feature"> <div class="feature-icon"><i class="fas fa-calendar-alt"></i></div> <div class="feature-text">Flexible scheduling to fit your life</div> </div>
          <div class="feature"> <div class="feature-icon"><i class="fas fa-graduation-cap"></i></div> <div class="feature-text">Personalized learning pathway</div> </div>
        </div>

        <!-- Call to Action Section -->
        <div class="cta-section" id="cta-section">
          <p id="login-prompt">Sign in with Google to begin your journey:</p>
          <!-- Google Sign-In Button Area -->
          <div class="google-btn-wrapper" id="google-signin-button-wrapper">
            <div id="g_id_onload"
                 data-client_id="969404171303-3dv2kqs2uhnqendr7kp6l1qcphjnoq40.apps.googleusercontent.com" /* TODO: Replace with your actual Client ID */
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleGoogleSignInResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
            </div>
             <!-- Area for displaying authentication errors -->
             <p id="auth-error-message"></p>
          </div>

           <!-- Continue Button Section (Initially Hidden) -->
           <div id="continue-section">
              <p id="success-prompt" style="margin-bottom: 1.5rem; font-weight: 500; color: var(--dark-color);">
                  <!-- Success message will be set by JS -->
              </p>
              <button id="continueButton" class="btn btn-primary" style="display: none;">
                 Continue <i class="fas fa-arrow-right"></i>
              </button>
           </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const authErrorMessage = document.getElementById('auth-error-message');
    const continueButton = document.getElementById('continueButton');
    const continueSection = document.getElementById('continue-section');
    const successPrompt = document.getElementById('success-prompt');
    const loginPrompt = document.getElementById('login-prompt');
    const googleButtonWrapper = document.getElementById('google-signin-button-wrapper');

    function clearAuthError() {
        if (authErrorMessage) {
            authErrorMessage.textContent = '';
            authErrorMessage.style.display = 'none';
        }
    }

    function showAuthError(message) {
         console.error("Auth Error:", message);
         if (authErrorMessage) {
             authErrorMessage.textContent = message;
             authErrorMessage.style.display = 'block';
         } else {
             alert(message);
         }
    }

    /**
     * Utility function to make fetch requests and handle common errors.
     */
    async function apiRequest(url, options) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                let errorMsg = `Request failed with status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || errorMsg;
                } catch (e) { /* Ignore if response body is not JSON */ }
                throw new Error(errorMsg);
            }
            // Handle cases where backend sends success but no JSON body (e.g., 204 No Content)
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                 return await response.json();
            } else {
                 return {}; // Return empty object if no JSON content
            }
        } catch (error) {
            console.error(`API Request Error (${url}):`, error);
            throw error; // Re-throw the error to be caught by the calling function
        }
    }


    /**
     * Handles the response from Google Sign-In.
     */
    async function handleGoogleSignInResponse(response) {
      console.log("Google Sign-In Response Received.");
      clearAuthError();

      const token = response.credential;
      if (!token) {
          showAuthError("Failed to get credential from Google. Please try again.");
          return;
      }

      console.log("Sending token to backend for verification...");

      try {
         // 1. Verify token with backend (creates session)
         // TODO: Replace '/api/auth/google' with your actual backend endpoint
         await apiRequest('/api/auth/google', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ token: token })
         });
         console.log("Backend verification successful.");

         // 2. Check user's setup progress
         // TODO: Replace '/api/user/status' with your actual backend endpoint
         const status = await apiRequest('/api/user/status', { method: 'GET' });
         console.log("User status received:", status);

         // 3. Determine next step and update UI
         // Example: Backend returns { setupComplete: { about: true, learningStyle: false, ... }, hasBooking: false }
         let nextUrl = 'aboutyourself.html'; // Default next step
         let message = 'You have successfully signed in. Complete your profile to continue.';

         if (status.hasBooking) {
             // User already has a booking, maybe redirect to profile or lessons
             nextUrl = 'profile.html'; // Or lessons.html
             message = 'Welcome back! View your booked lesson.';
         } else if (status.setupComplete?.about && status.setupComplete?.learningStyle && status.setupComplete?.proficiency) {
             // All setup steps done, ready to book
             nextUrl = 'booking.html';
             message = 'Welcome back! You are ready to book your free session.';
         } else if (status.setupComplete?.about && status.setupComplete?.learningStyle) {
              nextUrl = 'languageproficiency.html';
              message = 'Great! Just a few more details about your proficiency.';
         } else if (status.setupComplete?.about) {
             nextUrl = 'learningstyle.html';
             message = 'Welcome! Let\'s find your preferred learning style.';
         }
         // else: default is aboutyourself.html

         updateUiPostSignIn(nextUrl, message);

      } catch (error) {
          showAuthError(`Sign-in failed: ${error.message}. Please try again.`);
      }
    }

    /**
     * Updates the UI after successful sign-in and status check.
     */
    function updateUiPostSignIn(redirectUrl, message) {
      if (loginPrompt) loginPrompt.style.display = 'none';
      if (googleButtonWrapper) googleButtonWrapper.style.display = 'none';
      if (authErrorMessage) authErrorMessage.style.display = 'none';

      if (continueSection && successPrompt && continueButton) {
        successPrompt.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success-color); margin-right: 8px;"></i> ${message}`;
        continueButton.textContent = 'Continue'; // Reset text
         continueButton.style.display = 'inline-flex';

        // Set the correct redirection target
        continueButton.onclick = function() {
          console.log(`Continue button clicked. Redirecting to ${redirectUrl}...`);
          window.location.href = redirectUrl;
        };

        continueSection.style.display = 'block';
      } else {
          console.error("Could not find elements needed for post-sign-in UI update.");
      }
    }

    // Add a DOMContentLoaded listener to potentially check if user is *already* logged in
    // when they visit the page (e.g., session cookie exists).
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("Welcome page loaded. Checking initial auth status...");
        try {
            // TODO: Replace '/api/user/status' with your actual backend endpoint
            const status = await apiRequest('/api/user/status', { method: 'GET' });
            // If the request succeeds, the user is already logged in (valid session)
            console.log("User is already logged in. Status:", status);

            // Determine next step based on status (same logic as in handleGoogleSignInResponse)
            let nextUrl = 'aboutyourself.html';
            let message = 'Welcome back! Continue your setup.';

            if (status.hasBooking) {
                nextUrl = 'profile.html'; // Or lessons.html
                message = 'Welcome back! View your booked lesson.';
            } else if (status.setupComplete?.about && status.setupComplete?.learningStyle && status.setupComplete?.proficiency) {
                nextUrl = 'booking.html';
                message = 'Welcome back! You are ready to book your free session.';
             } else if (status.setupComplete?.about && status.setupComplete?.learningStyle) {
                nextUrl = 'languageproficiency.html';
                message = 'Great! Just a few more details about your proficiency.';
            } else if (status.setupComplete?.about) {
                nextUrl = 'learningstyle.html';
                message = 'Welcome back! Let\'s find your preferred learning style.';
            }

            updateUiPostSignIn(nextUrl, message); // Show continue button immediately

        } catch (error) {
            // If the status request fails (e.g., 401 Unauthorized), the user is not logged in.
            // No UI change needed, the Google Sign-In button should be visible.
            console.log("User not logged in or session expired.");
        }
    });

  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome | Fireship English Lessons</title>
  <!-- Google Sign-In API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- STYLES (Keep Existing Styles) --- */
    :root {
      --primary-color: #4361ee;
      --accent-color: #3a0ca3;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --success-color: #4cc9f0; /* Success messages/buttons */
      --danger-color: #f72585; /* Error messages */
      --border-radius: 8px;
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --transition-speed: 0.3s;
      --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--light-color); min-height: 100vh; color: var(--dark-color); padding: 0; margin: 0; }
    /* Header Styles */
    header { background-color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 0.75rem 2rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .header-logo { display: flex; align-items: center; height: 32px; overflow: visible; }
    .header-logo img { height: 64px; margin-right: 0.75rem; transform: translateY(-4px); }
    .header-logo span { font-weight: 600; font-size: 1.2rem; color: var(--primary-color); }
    /* Main Content */
    .main-container { display: flex; justify-content: center; align-items: center; padding: 40px 20px; min-height: calc(100vh - 60px); }
    .welcome-container { display: flex; max-width: 900px; width: 100%; background-color: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); }
    /* Image section */
    .image-section { flex: 1 1 45%; background: url('https://images.unsplash.com/photo-1488190211105-8b0e65b80b4e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=870&q=80') center/cover no-repeat; min-height: 500px; display: none; }
    /* Content section */
    .content-section { flex: 1 1 55%; padding: 3rem 2.5rem; display: flex; flex-direction: column; justify-content: center; }
    h1 { font-size: 2rem; margin-bottom: 1rem; color: var(--dark-color); line-height: 1.3; font-weight: 600; }
    p { color: #6c757d; margin-bottom: 2rem; line-height: 1.7; font-size: 1rem; }
    .features { margin-bottom: 2.5rem; }
    .feature { display: flex; align-items: center; margin-bottom: 1.2rem; }
    .feature-icon { color: var(--primary-color); width: 24px; height: 24px; margin-right: 1rem; font-size: 1.2rem; text-align: center; }
    .feature-text { font-size: 0.95rem; font-weight: 500; color: var(--dark-color); }
    /* CTA Section */
    .cta-section { margin-top: 2rem; text-align: center; }
    #login-prompt { font-size: 1rem; font-weight: 500; color: var(--dark-color); margin-bottom: 1.5rem; }
    .google-btn-wrapper { display: inline-block; position: relative; /* For error message positioning */ }
    /* Continue Button Section */
    #continue-section { display: none; margin-top: 2rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 28px; border-radius: 50px; font-weight: 600; transition: all var(--transition-speed) var(--transition-timing); cursor: pointer; font-size: 1rem; text-decoration: none; border: 2px solid transparent; }
    .btn-primary { background: linear-gradient(90deg, var(--primary-color), var(--success-color)); border-color: transparent; color: white; box-shadow: 0 6px 20px rgba(67, 97, 238, 0.25); }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(67, 97, 238, 0.35); filter: brightness(1.1); }
    .btn i { font-size: 0.9em; margin-left: 8px; }
    /* Error Message Style */
    #auth-error-message {
        display: none; /* Hidden by default */
        color: var(--danger-color);
        font-weight: 500;
        font-size: 0.9rem;
        margin-top: 1rem;
        text-align: center;
    }

    /* Responsive adjustments */
    @media (min-width: 768px) { .image-section { display: block; } .content-section { padding: 4rem 3rem; } h1 { font-size: 2.2rem; } }
    @media (max-width: 480px) { .content-section { padding: 2rem 1.5rem; } h1 { font-size: 1.8rem; } p { font-size: 0.95rem; } .feature-text { font-size: 0.9rem; } .btn { padding: 14px 24px; } .google-btn-wrapper { width: 100%; } .g_id_signin { display: flex !important; justify-content: center; } }

  </style>
</head>
<body>
  <!-- Header Section - Static Content -->
  <header>
    <div class="header-logo">
      <img src="https://imgur.com/bXjTJAj.png" alt="Fireship Logo">
      <span>Fireship</span>
    </div>
  </header>

  <!-- Main Content Section -->
  <div class="main-container">
    <div class="welcome-container">
      <div class="image-section"></div>
      <div class="content-section">
        <h1>Master English with Personalized 1-on-1 Lessons</h1>
        <p>Unlock your potential with expert tutors. Our lessons adapt to your unique learning style and goals, starting with a 100% free trial session!</p>
        <div class="features">
          <div class="feature"> <div class="feature-icon"><i class="fas fa-user-tie"></i></div> <div class="feature-text">Native-speaking certified tutors</div> </div>
          <div class="feature"> <div class="feature-icon"><i class="fas fa-calendar-alt"></i></div> <div class="feature-text">Flexible scheduling to fit your life</div> </div>
          <div class="feature"> <div class="feature-icon"><i class="fas fa-graduation-cap"></i></div> <div class="feature-text">Personalized learning pathway</div> </div>
        </div>

        <!-- Call to Action Section -->
        <div class="cta-section" id="cta-section">
          <p id="login-prompt">Sign in with Google to begin your journey:</p>
          <!-- Google Sign-In Button Area -->
          <div class="google-btn-wrapper" id="google-signin-button-wrapper">
            <div id="g_id_onload"
                 data-client_id="969404171303-3dv2kqs2uhnqendr7kp6l1qcphjnoq40.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleGoogleSignInResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
            </div>
             <!-- Area for displaying authentication errors -->
             <p id="auth-error-message"></p>
          </div>

           <!-- Continue Button Section (Initially Hidden) -->
           <div id="continue-section">
              <p id="success-prompt" style="margin-bottom: 1.5rem; font-weight: 500; color: var(--dark-color);">
                  <!-- Success message will be set by JS -->
              </p>
              <button id="continueButton" class="btn btn-primary" style="display: none;">
                 Continue <i class="fas fa-arrow-right"></i>
              </button>
           </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- DOM Elements ---
    const authErrorMessage = document.getElementById('auth-error-message');
    const continueButton = document.getElementById('continueButton');
    const continueSection = document.getElementById('continue-section');
    const successPrompt = document.getElementById('success-prompt');
    const loginPrompt = document.getElementById('login-prompt');
    const googleButtonWrapper = document.getElementById('google-signin-button-wrapper');

    // --- API Base URL ---
    const API_BASE_URL = 'https://api.fireship.org'; // Use the live API

    // --- Utilities ---
    function clearAuthError() {
        if (authErrorMessage) { authErrorMessage.textContent = ''; authErrorMessage.style.display = 'none'; }
    }
    function showAuthError(message) {
         console.error("Auth Error:", message);
         if (authErrorMessage) { authErrorMessage.textContent = message; authErrorMessage.style.display = 'block'; }
         else { alert(message); }
    }
    
    // Centralized API request with credentials included
    async function apiRequest(url, options = {}) {
         const fullUrl = url.startsWith('/') ? `${API_BASE_URL}${url}` : url;
         const opts = {
             credentials: 'include',         // <<< ensure cookies are sent/stored
             ...options,
         };
         console.debug(`API Req: ${opts.method||'GET'} ${fullUrl}`, opts);
         try {
             const r = await fetch(fullUrl, opts);
             if (!r.ok) {
                 let m = `API Error (${r.status})`;
                 let d = null;
                 try { d = await r.json(); m = d.message || m; } catch {}
                 console.error(`API Fail: ${r.status} ${r.statusText}`, d);
                 throw new Error(m);
             }
             const ct = r.headers.get('content-type');
             if (ct && ct.includes('application/json')) return await r.json();
             return {};
         } catch (e) {
              console.error(`API Exception:`, e);
              if (e.message.includes('failed to fetch')) throw new Error('Network error.');
              throw e;
         }
    }

    function updateUiPostSignIn(redirectUrl, message) {
         if (loginPrompt) loginPrompt.style.display = 'none';
         if (googleButtonWrapper) googleButtonWrapper.style.display = 'none';
         if (authErrorMessage) authErrorMessage.style.display = 'none';
         if (continueSection && successPrompt && continueButton) {
             successPrompt.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success-color); margin-right: 8px;"></i> ${message}`;
             continueButton.style.display = 'inline-flex';
             continueButton.onclick = () => { window.location.href = redirectUrl; };
             continueSection.style.display = 'block';
         }
    }

    // --- Google Sign-In Handler ---
    async function handleGoogleSignInResponse(response) {
      clearAuthError();
      const token = response.credential;
      if (!token) { showAuthError('Google credential missing.'); return; }

      try {
         await apiRequest('/api/auth/google', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ token })
         });

         const status = await apiRequest('/api/user/status', { method: 'GET' });

         let nextUrl = 'aboutyourself.html';
         let message = 'Sign-in successful. Please continue setup.';
         if (status.hasBooking) {
             nextUrl = 'profile.html'; message = 'Welcome back! View your lesson.';
         } else if (status.setupComplete?.about && status.setupComplete?.learningStyle && status.setupComplete?.proficiency) {
             nextUrl = 'booking.html'; message = 'Welcome back! Ready to book.';
         } else if (status.setupComplete?.about && status.setupComplete?.learningStyle) {
             nextUrl = 'languageproficiency.html'; message = 'Great! Next: proficiency.';
         } else if (status.setupComplete?.about) {
             nextUrl = 'learningstyle.html'; message = 'Welcome! Next: learning style.';
         }

         updateUiPostSignIn(nextUrl, message);

      } catch (error) {
          console.error('Error during sign-in flow:', error);
          const msg = error.message.includes('401')
                      ? 'Authentication failed. Please ensure cookies are enabled and try again.'
                      : error.message.includes('Network error')
                        ? 'Network error. Please check your connection and try again.'
                        : `Sign-in failed: ${error.message}`;
          showAuthError(msg);
      }
    }

  </script>
</body>
</html>

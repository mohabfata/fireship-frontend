<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Learning Style | Fireship English</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- STYLES (Keep Existing Styles from learningstyle.html first) --- */
        :root {
             /* Use learningstyle.html variables for consistency on this page */
             --primary-color: #5A8DEE;
             --secondary-color: #3DDC97;
             --dark-purple: #4B0082;
             --accent-color: #FF6347; /* Used by some general styles */
             --success-color: #28a745; /* Used by some general styles */
             --danger-color: #f72585; /* Added from profile header for consistency */
             --warning-color: #ffc107;
             --light-color: #ffffff;
             --bg-light: #f8faff; /* Used by profile dropdown */
             --bg-section-alt: #f5f8fd;
             --dark-color: #34495e; /* Used by header text */
             --gray-color: #8492a6; /* Used by header icons */
             --border-color: #eef2f7; /* Used by header border, dropdown border */
             --input-bg-color: #f7faff;
             --border-radius: 16px; /* Profile uses 8px, keep 16px for main content */
             --box-shadow: 0 22px 55px rgba(90, 141, 238, 0.18);
             --box-shadow-light: 0 10px 30px rgba(0, 0, 0, 0.06);
             --transition-speed: 0.4s;
             --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
             --animation-speed: 0.5s;
         }
        /* --- Base Styles (Keep from learningstyle.html) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; scroll-padding-top: 70px; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-light); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23eaf2ff' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v1 S9 22.5 9 22.5h10v-1.5S23 15 23 15L12.99 7.5zM28 19.09v15l-14 8.08L0 34.09v-15L14 5.91 28 19.09z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); min-height: 100vh; color: var(--dark-color); line-height: 1.7; overflow-x: hidden; padding-top: 70px; }

        /* --- Header Styles (Imported and adapted from Profile.html) --- */
        header.main-header {
            background-color: white; /* Solid white initially */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            padding: 0 2rem; /* Use profile padding */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between; /* Space between logo and profile */
            align-items: center;
            height: 70px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        body.scrolled header.main-header {
            background-color: rgba(255, 255, 255, 0.97); /* Slightly transparent on scroll */
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
            border-bottom: 1px solid var(--border-color);
        }
        .header-logo-link { /* Added from profile */
            display: flex;
            align-items: center;
            text-decoration: none;
            height: 100%;
        }
        .header-logo {
            display: flex;
            align-items: center;
            height: 40px;
            overflow: visible;
        }
        .header-logo img {
            height: 80px; /* Profile header uses 80px */
            margin-right: 0.8rem;
            transform: translateY(-7px); /* Profile header transform */
        }
        .header-logo span {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        /* User Profile Header (Copied from Profile.html) */
        .user-profile-header {
            display: none; /* Initially hidden, shown by JS if logged in */
            align-items: center;
            gap: 12px;
            position: relative;
            cursor: pointer;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            object-fit: cover;
            background-color: #eee;
        }
        .user-name-header {
            font-weight: 600;
            color: var(--dark-color);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .notification-dot {
            width: 10px;
            height: 10px;
            /* Use a distinct color like accent or dark purple if primary is used elsewhere */
            background-color: var(--dark-purple); /* Adjusted color */
            border-radius: 50%;
            position: absolute;
            top: 0;
            right: 0;
            border: 1.5px solid white;
            display: none; /* Shown by JS */
        }
        .profile-dropdown {
            display: none; /* Toggled by JS */
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: white;
            border-radius: 8px; /* Use profile border-radius */
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            z-index: 1010;
            min-width: 200px;
            overflow: hidden;
            list-style: none;
            padding: 8px 0;
        }
        .profile-dropdown a, .profile-dropdown button {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 10px 18px;
            color: var(--dark-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .profile-dropdown a:hover, .profile-dropdown button:hover {
            background-color: var(--bg-light); /* Use learningstyle variable */
            color: var(--primary-color);
        }
        .profile-dropdown a i, .profile-dropdown button i {
            margin-right: 12px;
            color: var(--gray-color); /* Use learningstyle variable */
            transition: color 0.2s ease;
            width: 16px;
            text-align: center;
        }
        .profile-dropdown a:hover i, .profile-dropdown button:hover i {
            color: var(--primary-color);
        }
        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 8px 0;
        }
        .lessons-link span { flex-grow: 1; }
        .lessons-link .notification-dot { /* Style for dot inside link */
            position: static;
            display: inline-block;
            margin-left: 8px;
            width: 8px;
            height: 8px;
            vertical-align: middle;
            background-color: var(--dark-purple); /* Match header dot */
            border-radius: 50%;
            border: 1px solid white;
            visibility: hidden; /* Toggled by JS */
        }
        .lessons-link .notification-dot.visible { visibility: visible; }
        #signInLink {
            display: none; /* Hidden by default, shown by JS if logged out */
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 18px;
            border: 2px solid var(--primary-color);
            border-radius: 50px;
            transition: all var(--transition-speed) var(--transition-timing);
        }
        #signInLink:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px 40px; min-height: calc(100vh - 70px); display: flex; flex-direction: column; }
        /* --- Progress Bar (Keep Existing Styles) --- */
        .progress-container { padding: 40px 0 30px; display: flex; justify-content: center; align-items: center; margin-bottom: 30px; } .progress-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 700px; position: relative; } .progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 4px; width: 100%; background-color: var(--border-color); z-index: 1; border-radius: 2px; } .progress-bar-fill { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); z-index: 2; transition: width var(--transition-speed) var(--transition-timing); border-radius: 2px; } .step { width: 36px; height: 36px; border-radius: 50%; background-color: var(--light-color); border: 3px solid var(--border-color); display: flex; justify-content: center; align-items: center; font-weight: 700; color: var(--gray-color); position: relative; z-index: 3; transition: all var(--transition-speed) var(--transition-timing); box-shadow: 0 2px 5px rgba(0,0,0,0.05); } .step span { font-size: 0.95rem; transition: opacity 0.2s ease; } .step.active { border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1); box-shadow: 0 4px 10px rgba(90, 141, 238, 0.2); } .step.completed { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-color: var(--primary-color); color: var(--light-color); box-shadow: 0 3px 8px rgba(90, 141, 238, 0.2); } .step.completed::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 0.9rem; position: absolute; color: var(--light-color); opacity: 1; transition: opacity 0.2s ease; } .step.completed span { opacity: 0; } .step-label { position: absolute; top: 45px; left: 50%; transform: translateX(-50%); font-size: .9rem; font-weight: 500; color: var(--gray-color); text-align: center; width: 130px; white-space: normal; transition: color var(--transition-speed); } .step.active .step-label { color: var(--primary-color); font-weight: 600; } .step.completed .step-label { color: var(--dark-color); }
        /* --- Section Titles (Keep Existing Styles) --- */
        .section-title { text-align: center; margin-bottom: 45px; padding-top: 20px; } .section-title h1 { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 12px; } .section-title p { font-size: 1.15rem; color: var(--gray-color); max-width: 650px; margin: 0 auto; line-height: 1.8; }
        /* --- Options Grid (Keep Existing Styles) --- */
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 35px; margin-bottom: 40px; }
        /* --- Option Card Styling (Keep Existing Styles) --- */
        .option-card { background-color: var(--light-color); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow-light); cursor: pointer; position: relative; border: 2px solid var(--border-color); height: 100%; display: flex; flex-direction: column; opacity: 0; transform: translateY(20px); transition: opacity var(--animation-speed) ease-out var(--card-animation-delay, 0s), transform var(--animation-speed) ease-out var(--card-animation-delay, 0s), border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; } .option-card.animate-in { opacity: 1; transform: translateY(0); } .option-card:hover { transform: translateY(-10px); box-shadow: var(--box-shadow); border-color: rgba(90, 141, 238, 0.5); } .option-card.selected { border-color: var(--primary-color); border-width: 3px; box-shadow: 0 8px 25px rgba(90, 141, 238, 0.2); } .option-header { padding: 25px 30px 15px; border-bottom: 1px solid var(--border-color); position: relative; } .option-icon { position: absolute; top: 25px; right: 30px; font-size: 2.2rem; color: var(--primary-color); opacity: 0.7; transition: transform var(--transition-speed) ease; } .option-card:hover .option-icon { transform: scale(1.1) rotate(-5deg); } .option-title { font-size: 1.5rem; font-weight: 600; color: var(--dark-color); margin-bottom: 8px; } .option-subtitle { font-size: 1rem; color: var(--gray-color); margin-bottom: 5px; font-weight: 500; } .option-body { padding: 25px 30px; flex-grow: 1; } .option-description { font-size: 1rem; color: var(--gray-color); line-height: 1.8; } .option-footer { padding: 20px 30px; background-color: var(--bg-section-alt); border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; margin-top: auto; } .option-tag { font-size: .85rem; padding: 6px 15px; border-radius: 50px; background-color: rgba(90, 141, 238, 0.1); color: var(--primary-color); font-weight: 600; } .option-select { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all var(--transition-speed) var(--transition-timing); background-color: var(--light-color); } .option-card.selected .option-select { border-color: var(--primary-color); background-color: var(--primary-color); } .option-select .fa-check { font-size: 1rem; color: var(--light-color); opacity: 0; transform: scale(0.5); transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease; } .option-card.selected .option-select .fa-check { opacity: 1; transform: scale(1); }
        /* --- Navigation Buttons (Keep Existing Styles) --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: auto; padding: 40px 0 10px; border-top: 1px solid var(--border-color); margin-top: 40px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 28px; border-radius: 50px; font-weight: 600; transition: all var(--transition-speed) var(--transition-timing); cursor: pointer; font-size: 1rem; text-decoration: none; border: 2px solid transparent; } .btn i { font-size: 0.9em; } .btn-outline { background-color: transparent; border-color: var(--border-color); color: var(--gray-color); box-shadow: none; } .btn-outline:hover { border-color: var(--gray-color); color: var(--dark-color); background-color: rgba(132, 146, 166, 0.05); transform: translateY(-2px); } .btn-primary { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-color: transparent; color: white; box-shadow: 0 6px 20px rgba(90, 141, 238, 0.25); } .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(90, 141, 238, 0.35); filter: brightness(1.1); } .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; filter: grayscale(60%); pointer-events: none; background: var(--gray-color); } .btn-primary:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(90, 141, 238, 0.2); }
         /* Loading state for buttons (Keep Existing Styles) */
         .btn .btn-text { display: inline; } .btn .btn-loader { display: none; } .btn .btn-icon { display: inline-block; }
         .btn.loading .btn-text { display: none; } .btn.loading .btn-loader { display: inline-block; } .btn.loading .btn-icon { display: none; }
        /* Step Screens (Keep Existing Styles) */
        .step-screen { display: none; } .step-screen.active { display: block; }
        /* Recommendation Screen (Keep Existing Styles) */
        .recommendation { background-color: var(--light-color); border-radius: var(--border-radius); padding: 50px 40px; box-shadow: var(--box-shadow); border: 1px solid var(--border-color); margin: 40px auto; max-width: 850px; text-align: center; opacity: 0; transform: translateY(20px); transition: opacity var(--animation-speed) ease-out var(--card-animation-delay, 0s), transform var(--animation-speed) ease-out var(--card-animation-delay, 0s); } .recommendation.animate-in { opacity: 1; transform: translateY(0); } .recommendation-icon { font-size: 3.5rem; color: var(--primary-color); margin-bottom: 20px; display: inline-block; } .recommendation-title { font-size: 2rem; font-weight: 700; color: var(--dark-color); margin-bottom: 15px; } .recommendation-subtitle { font-size: 1.3rem; color: var(--primary-color); margin-bottom: 25px; font-weight: 600; } .recommendation-description { font-size: 1.1rem; color: var(--gray-color); margin-bottom: 40px; max-width: 650px; margin-left: auto; margin-right: auto; line-height: 1.8; } .btn-large { padding: 18px 45px !important; font-size: 1.2rem !important; font-weight: 700 !important; background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important; box-shadow: 0 10px 30px rgba(90, 141, 238, 0.3) !important; } .btn-large:hover:not(:disabled) { box-shadow: 0 15px 35px rgba(90, 141, 238, 0.4) !important; }
        /* Submission Feedback (Keep Existing Styles) */
        #submissionFeedback { text-align: center; margin-top: 1rem; font-weight: 500; font-size: 0.95rem; display: none; }
        #submissionFeedback.success { color: var(--success-color); }
        #submissionFeedback.error { color: var(--accent-color); }
        /* Animation Keyframes (Keep Existing Styles) */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
        /* Responsive (Keep Existing Styles) */
        @media (max-width: 768px) {
             header.main-header{ padding: 0 1.5rem;} /* Adjust header padding */
             .section-title h1 { font-size: 2.2rem; } .step-label { font-size: .8rem; width: 100px; } .options-grid { grid-template-columns: 1fr; } .recommendation { padding: 40px 25px; } .recommendation-title { font-size: 1.8rem; } .recommendation-subtitle { font-size: 1.2rem; } .nav-buttons { padding: 30px 0 10px; margin-top: 30px;}
         }
        @media (max-width: 576px) {
             header.main-header{ padding: 0 1rem;} /* Adjust header padding */
             .user-name-header { display: none; } /* Hide name on small screens */
             .progress-container { padding: 30px 0 20px; } .step { width: 32px; height: 32px; } .step span { font-size: 0.9rem;} .step.completed::after { font-size: 0.8rem; } .step-label { display: none; } .section-title h1 { font-size: 2rem; } .section-title p { font-size: 1rem; } .options-grid { gap: 20px; margin-bottom: 30px; } .option-card { margin-bottom: 0; } .option-header { padding: 20px 20px 12px; } .option-body { padding: 20px 20px; } .option-footer { padding: 15px 20px; } .option-title { font-size: 1.3rem; } .option-description { font-size: 0.95rem; line-height: 1.7; } .nav-buttons { padding: 25px 0 10px; } .btn { padding: 10px 24px; } .recommendation { padding: 30px 20px; } .recommendation-title { font-size: 1.6rem; } .recommendation-description { font-size: 1rem; } .btn-large { padding: 15px 35px !important; font-size: 1.1rem !important;}
        }

    </style>
</head>
<body>
  <!-- Header (Imported from Profile.html) -->
  <header class="main-header">
    <a href="Index.html" class="header-logo-link"> <!-- Use link from profile -->
        <div class="header-logo">
            <img src="https://imgur.com/bXjTJAj.png" alt="Fireship Logo">
            <span>Fireship</span>
        </div>
    </a>
    <!-- Sign In Link (Shown/Hidden by JS) -->
    <a href="welcome.html?source=signIn" id="signInLink" style="display: none;">Sign In</a>
    <!-- User Profile Area (Shown/Hidden by JS) -->
    <div class="user-profile-header" id="user-profile-header">
         <span class="user-name-header" id="userNameHeader">User</span>
         <img src="placeholder-avatar.png" alt="User Avatar" class="user-avatar" id="userAvatarHeader">
         <div class="notification-dot" id="notificationDot"></div>
         <div class="profile-dropdown" id="profileDropdown">
             <a href="profile.html"><i class="fas fa-user-circle"></i> My Profile</a>
             <a href="lessons.html" class="lessons-link">
                 <i class="fas fa-calendar-check"></i>
                 <span>My Lessons</span>
                 <span class="notification-dot" id="lessonsNotificationDot"></span>
             </a>
             <div class="dropdown-divider"></div>
             <button id="signOutBtn"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
         </div>
    </div>
  </header>


  <div class="container">
    <!-- Progress Bar (Keep Existing) -->
    <div class="progress-container"> <div class="progress-bar"> <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div> <div class="step step-1 active"><span>1</span><div class="step-label">Learning Focus</div></div> <div class="step step-2"><span>2</span><div class="step-label">Approach</div></div> <div class="step step-3"><span>3</span><div class="step-label">Specialization</div></div> <div class="step step-4"><span>4</span><div class="step-label">Your Path</div></div> </div> </div>

    <!-- Step Screens Wrapper (Keep Existing) -->
    <div class="step-screens-wrapper">
        <!-- Step 1 -->
        <div class="step-screen step-1-screen active"> <div class="section-title"> <h1>What's your main learning goal?</h1> <p>Select the focus area that aligns best with your English learning objectives.</p> </div> <div class="options-grid"> <div class="option-card" data-key="fluency"> <div class="option-header"> <div class="option-icon">ğŸ“£</div> <h3 class="option-title">Comprehensive Fluency</h3> <h4 class="option-subtitle">Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h4> </div> <div class="option-body"> <p class="option-description">Develop natural communication skills for everyday and professional settings. Our fluency-focused approach helps you speak confidently.</p> </div> <div class="option-footer"> <div class="option-tag">Most Popular</div> <div class="option-select"><i class="fas fa-check"></i></div> </div> </div> <div class="option-card" data-key="structure"> <div class="option-header"> <div class="option-icon">âœï¸</div> <h3 class="option-title">Structure & Accuracy</h3> <h4 class="option-subtitle">Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ø¯Ù‚Ø©</h4> </div> <div class="option-body"> <p class="option-description">Master the fundamentals of English grammar and precise sentence construction. Build a solid language foundation for clarity.</p> </div> <div class="option-footer"> <div class="option-tag">Foundation</div> <div class="option-select"><i class="fas fa-check"></i></div> </div> </div> <div class="option-card" data-key="testprep"> <div class="option-header"> <div class="option-icon">ğŸ¯</div> <h3 class="option-title">Test Preparation</h3> <h4 class="option-subtitle">Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4> </div> <div class="option-body"> <p class="option-description">Strategic preparation for IELTS, TOEFL, etc. Get focused training, timed practice, and expert guidance to achieve your target score.</p> </div> <div class="option-footer"> <div class="option-tag">Goal-Oriented</div> <div class="option-select"><i class="fas fa-check"></i></div> </div> </div> </div> <div class="nav-buttons"> <div></div> <button id="step1Next" class="btn btn-primary" disabled> <span class="btn-text">Continue</span> <i class="fas fa-spinner fa-spin btn-loader" style="display: none;"></i> <i class="fas fa-arrow-right btn-icon"></i> </button> </div> </div>
        <!-- Step 2 -->
        <div class="step-screen step-2-screen"> <div class="section-title"> <h1>What approach works best for you?</h1> <p>Choose the learning method that matches your preferences and goals.</p> </div> <div class="options-grid" id="step2Options"></div> <div class="nav-buttons"> <button id="step2Back" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Back</button> <button id="step2Next" class="btn btn-primary" disabled> <span class="btn-text">Continue</span> <i class="fas fa-spinner fa-spin btn-loader" style="display: none;"></i> <i class="fas fa-arrow-right btn-icon"></i> </button> </div> </div>
        <!-- Step 3 -->
        <div class="step-screen step-3-screen"> <div class="section-title"> <h1>Fine-tune your learning experience</h1> <p>Select a specialized focus to customize your sessions.</p> </div> <div class="options-grid" id="step3Options"></div> <div class="nav-buttons"> <button id="step3Back" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Back</button> <button id="step3Next" class="btn btn-primary" disabled> <span class="btn-text">See Your Recommendation</span> <i class="fas fa-spinner fa-spin btn-loader" style="display: none;"></i> <i class="fas fa-arrow-right btn-icon"></i> </button> </div> </div>
        <!-- Step 4 -->
        <div class="step-screen step-4-screen"> <div class="section-title"> <h1>Your Personalized Learning Path</h1> <p>Based on your preferences, we've created the perfect learning journey for you.</p> </div> <div class="recommendation"> <div class="recommendation-icon"><i class="fas fa-star"></i></div> <div class="recommendation-title">Your Recommended Path</div> <div class="recommendation-subtitle" id="recommendationTitle">Recommendation Title Placeholder</div> <p class="recommendation-description" id="recommendationDescription"> Recommendation description placeholder text. This will be updated based on user selections. </p> <button id="saveLearningStyleButton" class="btn btn-primary btn-large"> <span class="btn-text">Continue to Proficiency Check</span> <i class="fas fa-spinner fa-spin btn-loader" style="display: none;"></i> <i class="fas fa-arrow-right btn-icon"></i> </button> <div id="submissionFeedback" style="margin-top: 15px;"></div> </div> <div class="nav-buttons"> <button id="step4Back" class="btn btn-outline"><i class="fas fa-redo-alt"></i> Start Over</button> <div></div> </div> </div>
    </div><!-- End step-screens-wrapper -->
  </div><!-- End container -->

  <script>
    // --- Learning Data (Keep Existing Data) ---
    const learningData = { step1: [ {key:"fluency", title:"Comprehensive Fluency", subtitle:"Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©", description:"Develop natural communication skills for everyday and professional settings. Our fluency-focused approach helps you speak confidently.", icon:"ğŸ“£", tag:"Most Popular"}, {key:"structure", title:"Structure & Accuracy", subtitle:"Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ø¯Ù‚Ø©", description:"Master the fundamentals of English grammar and precise sentence construction. Build a solid language foundation for clarity.", icon:"âœï¸", tag:"Foundation"}, {key:"testprep", title:"Test Preparation", subtitle:"Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª", description:"Strategic preparation for IELTS, TOEFL, etc. Get focused training, timed practice, and expert guidance to achieve your target score.", icon:"ğŸ¯", tag:"Goal-Oriented"} ], step2: { fluency: [ {key:"everyday", title:"Everyday Conversation", subtitle:"Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", description:"Focus on practical language skills for real-life situations. Develop natural expressions and responses for daily interactions.", icon:"ğŸ—£ï¸", tag:"Real-Life"}, {key:"business", title:"Business Communication", subtitle:"Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠ", description:"Enhance your professional English with specialized vocabulary, formal techniques, and strategies for effective workplace interactions.", icon:"ğŸ’¼", tag:"Career"}, {key:"social", title:"Social Interaction", subtitle:"Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", description:"Develop confidence in social settings with focus on conversation starters, cultural nuances, and engaging discussions.", icon:"ğŸ‘¥", tag:"Confidence"} ], structure: [ {key:"grammarBasics", title:"Grammar Fundamentals", subtitle:"Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯", description:"Build a strong foundation with systematic coverage of English grammar rules, tenses, and sentence patterns.", icon:"ğŸ“š", tag:"Core Knowledge"}, {key:"advancedWriting", title:"Advanced Writing", subtitle:"Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", description:"Develop sophisticated writing skills for academic, professional, or creative purposes. Learn logical organization and clear expression.", icon:"âœï¸", tag:"Expression"}, {key:"errorCorrection", title:"Error Correction", subtitle:"ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡", description:"Identify and eliminate common mistakes in your speech and writing. Recognize error patterns and develop avoidance strategies.", icon:"ğŸ”", tag:"Precision"} ], testprep: [ {key:"examStrategies", title:"Exam Strategies", subtitle:"Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†", description:"Master test-taking techniques specific to your target exam. Learn time management, question analysis, and score maximization.", icon:"â±ï¸", tag:"Techniques"}, {key:"practiceTests", title:"Practice & Feedback", subtitle:"Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©", description:"Intensive preparation through simulated exam conditions with detailed performance analysis and personalized feedback.", icon:"ğŸ“", tag:"Performance"}, {key:"vocabComprehension", title:"Vocabulary & Comprehension", subtitle:"Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª ÙˆØ§Ù„ÙÙ‡Ù…", description:"Expand your lexical range and improve reading/listening skills specifically for test requirements. Build necessary vocabulary depth.", icon:"ğŸ“–", tag:"Content"} ] }, step3: { everyday: [ {key:"spontaneous", title:"Spontaneous Dialogue", subtitle:"Ø­ÙˆØ§Ø±Ø§Øª Ø¹ÙÙˆÙŠØ©", description:"Practice unplanned, natural conversations to build quick-thinking skills. Develop the ability to respond naturally without rehearsal.", icon:"ğŸ’¬", tag:"Improvisation"}, {key:"scenarios", title:"Scenario Role-Plays", subtitle:"ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª", description:"Prepare for specific real-life situations (travel, shopping, dining) through structured role-playing exercises.", icon:"ğŸ­", tag:"Practical"} ], business: [ {key:"meetings", title:"Professional Meetings", subtitle:"Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ù…Ù‡Ù†ÙŠØ©", description:"Master the language of workplace discussions, negotiations, and decision-making. Learn phrases for leading and contributing.", icon:"ğŸ¤", tag:"Workplace"}, {key:"presentations", title:"Presentation Skills", subtitle:"Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶", description:"Develop compelling public speaking abilities in English. Learn structure, delivery, audience engagement, and Q&A handling.", icon:"ğŸ“Š", tag:"Public Speaking"} ], social: [ {key:"cultural", title:"Cultural Discussions", subtitle:"Ù…Ù†Ø§Ù‚Ø´Ø§Øª Ø«Ù‚Ø§ÙÙŠØ©", description:"Engage in conversations about arts, current events, traditions, and global topics. Build vocabulary and express opinions.", icon:"ğŸŒ", tag:"Global"}, {key:"networking", title:"Casual Networking", subtitle:"ØªÙˆØ§ØµÙ„ ØºÙŠØ± Ø±Ø³Ù…ÙŠ", description:"Master small talk, introductions, and building rapport. Develop strategies for mingling and sustaining engaging conversations.", icon:"ğŸ”„", tag:"Connections"} ], grammarBasics: [ {key:"sentences", title:"Sentence Construction", subtitle:"Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù…Ù„", description:"Focus on building well-formed sentences with proper structure. Practice combining simple sentences into complex ones accurately.", icon:"ğŸ—ï¸", tag:"Structure"}, {key:"tenses", title:"Tense Mastery", subtitle:"Ø§Ù„Ø£Ø²Ù…Ù†Ø©", description:"Develop deep understanding and application of English verb tenses. Learn context-appropriate usage and seamless timeframe shifts.", icon:"â°", tag:"Time"} ], advancedWriting: [ {key:"essay", title:"Essay Composition", subtitle:"ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù‚Ø§Ù„", description:"Learn to craft well-structured essays with clear theses, supporting arguments, and coherent organization for various formats.", icon:"ğŸ“„", tag:"Academic"}, {key:"creative", title:"Creative Writing", subtitle:"Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ©", description:"Explore creative potential through storytelling and expressive language. Develop your unique voice and writing technique.", icon:"âœ¨", tag:"Artistic"} ], errorCorrection: [ {key:"identify", title:"Error Pattern Recognition", subtitle:"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡", description:"Analyze recurring language mistakes and develop awareness. Learn to self-correct and gradually eliminate common errors.", icon:"ğŸ”", tag:"Analytical"}, {key:"refinement", title:"Precision Drills", subtitle:"ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ø¯Ù‚Ø©", description:"Engage in focused exercises targeting specific accuracy issues. Build automaticity with grammatical structures.", icon:"ğŸ¯", tag:"Targeted"} ], examStrategies: [ {key:"timeManagement", title:"Time Management", subtitle:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª", description:"Master techniques for optimizing exam time, including prioritization, pacing, and handling challenging sections efficiently.", icon:"â±ï¸", tag:"Efficiency"}, {key:"questionAnalysis", title:"Question Analysis", subtitle:"ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", description:"Develop skills to quickly understand questions and identify strategic approaches. Recognize patterns for faster correct answers.", icon:"ğŸ§©", tag:"Strategy"} ], practiceTests: [ {key:"mockExams", title:"Full Mock Exams", subtitle:"Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©", description:"Take complete practice tests under timed conditions simulating the real exam. Build stamina and comfort with formats.", icon:"ğŸ“‹", tag:"Simulation"}, {key:"reviewSessions", title:"Detailed Analysis", subtitle:"Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", description:"Receive comprehensive feedback on test performance with in-depth explanations. Identify gaps and develop improvement strategies.", icon:"ğŸ“ˆ", tag:"Optimization"} ], vocabComprehension: [ {key:"vocabBuilding", title:"Strategic Vocabulary", subtitle:"Ù…ÙØ±Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©", description:"Build high-value vocabulary relevant to your target exam. Learn word relationships, collocations, and sophisticated usage.", icon:"ğŸ“š", tag:"Lexical"}, {key:"readingDrills", title:"Comprehension Techniques", subtitle:"ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ÙÙ‡Ù…", description:"Master strategies for quickly understanding complex texts/audio. Practice skimming, scanning, inference, and critical skills.", icon:"ğŸ”", tag:"Processing"} ] } };

    // --- User Path & DOM Elements ---
    let userPath = {step1: null, step2: null, step3: null};
    const els = {
        progressFill: document.getElementById('progressBarFill'),
        step1Next: document.getElementById('step1Next'),
        step2Back: document.getElementById('step2Back'),
        step2Next: document.getElementById('step2Next'),
        step3Back: document.getElementById('step3Back'),
        step3Next: document.getElementById('step3Next'),
        step4Back: document.getElementById('step4Back'),
        step2Options: document.getElementById('step2Options'),
        step3Options: document.getElementById('step3Options'),
        recTitle: document.getElementById('recommendationTitle'),
        recDesc: document.getElementById('recommendationDescription'),
        saveButton: document.getElementById('saveLearningStyleButton'),
        submissionFeedback: document.getElementById('submissionFeedback'),
        allSteps: document.querySelectorAll('.step-screen'),
        allProgressSteps: document.querySelectorAll('.progress-bar .step'),
        // Header Elements (Imported from Profile.html JS)
        signInLink: document.getElementById('signInLink'),
        userProfileHeader: document.getElementById('user-profile-header'),
        userNameHeader: document.getElementById('userNameHeader'),
        userAvatarHeader: document.getElementById('userAvatarHeader'),
        profileDropdown: document.getElementById('profileDropdown'),
        signOutBtn: document.getElementById('signOutBtn'),
        notificationDot: document.getElementById('notificationDot'),
        lessonsNotificationDot: document.getElementById('lessonsNotificationDot')
    };
    let currentStep = 1; // Track current step (start at 1 for this page)

    // --- Utility Functions ---

    // Add this line BEFORE the apiRequest function definition
    const API_BASE_URL = 'https://api.fireship.org'; // <-- YOUR LIVE API URL

    async function apiRequest(url, options = {}) { // Default options to {}
         const fullUrl = url.startsWith('/') ? API_BASE_URL + url : url; // Use constant

         // Create opts object including credentials
         const opts = {
             credentials: 'include', // <-- Add credentials: 'include'
             ...options, // Merge other passed options
         };

         console.debug(`API Req: ${opts.method || 'GET'} ${fullUrl}`); // Log method and fullUrl

         try {
             // Use fullUrl and opts in the fetch call
             const r = await fetch(fullUrl, opts);

             if (!r.ok) {
                 let errorMsg = `API Error (${r.status})`;
                 let errorData = null;
                 try { errorData = await r.json(); errorMsg = errorData.message || errorMsg; } catch (e) { /* ignore */ }
                 console.error(`API Fail: ${r.status} ${r.statusText} @ ${fullUrl}`, errorData);

                 // Specific handling for 401 - Redirect
                 if (r.status === 401 && !fullUrl.includes('/api/auth/logout')) {
                     console.warn("API 401 Unauthorized detected, redirecting to welcome page.");
                     window.location.href = 'welcome.html';
                     return null; // Signal redirect
                 }
                 throw new Error(errorData?.message || `Request failed: ${r.status}`);
             }

             const ct = r.headers.get("content-type");
             if (ct?.includes("application/json")) {
                 const d = await r.json();
                 console.debug(`API OK JSON @ ${fullUrl}:`, d);
                 return d;
             } else {
                 console.debug(`API OK NoJSON @ ${fullUrl} (${r.status})`);
                 return { success: true }; // Indicate success for non-JSON OK responses
             }
         } catch (e) {
              console.error(`API Excep (${fullUrl}):`, e);
              if (e.message.toLowerCase().includes('failed to fetch')) {
                  throw new Error("Network error. Please check your connection.");
              }
              throw e;
         }
    }


    function showButtonLoading(button, isLoading) {
        if (!button) return;
        const btnText = button.querySelector('.btn-text');
        const btnLoader = button.querySelector('.btn-loader');
        const btnIcon = button.querySelector('.btn-icon');

        button.disabled = isLoading;
        button.classList.toggle('loading', isLoading);

        if (btnText) btnText.style.display = isLoading ? 'none' : 'inline';
        if (btnLoader) btnLoader.style.display = isLoading ? 'inline-block' : 'none';
        if (btnIcon) btnIcon.style.display = isLoading ? 'none' : 'inline-block';
    }

    function showFeedback(message, isError = false) {
        if (els.submissionFeedback) {
            els.submissionFeedback.textContent = message;
            els.submissionFeedback.className = isError ? 'error' : 'success';
            els.submissionFeedback.style.display = 'block';
        } else {
            alert(message);
        }
    }

    function clearFeedback() {
        if (els.submissionFeedback) {
            els.submissionFeedback.textContent = '';
            els.submissionFeedback.style.display = 'none';
        }
    }

    // --- Fetch and potentially pre-fill / skip ---
    async function checkExistingPreferences() {
         console.log("Checking for existing learning style preferences...");
         try {
             // Use the updated apiRequest function
             const prefs = await apiRequest('/api/user/preferences/learning-style', { method: 'GET' });
             if (prefs === null) return; // Redirect happened or fatal API error

             if (prefs && prefs.step1 && prefs.step2 && prefs.step3) {
                 console.log("Found existing preferences:", prefs);
                 userPath = prefs;
                 updateRecommendation();
                 goToStep(4);
             } else {
                  console.log("No complete existing preferences found. Starting flow.");
                  goToStep(1);
             }
         } catch (error) {
             console.warn("Could not fetch existing preferences:", error.message);
              // If error (like network), start the normal flow
             goToStep(1);
         }
    }


    // --- Core Logic Functions ---
    function showStep(num) {
        console.log(`Attempting to show Step: ${num}`);
        currentStep = num;
        const currentScreen = document.querySelector(`.step-${num}-screen`);
        if (currentScreen) {
            els.allSteps.forEach(s => s.classList.remove('active'));
            currentScreen.classList.add('active');

            els.allProgressSteps.forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                const stepNum = index + 1;
                if (stepNum < num) {
                    stepEl.classList.add('completed');
                } else if (stepNum === num) {
                    stepEl.classList.add('active');
                }
            });

            const totalProgressSteps = 4;
            const percentage = num <= 1 ? 0 : ((num - 1) / (totalProgressSteps - 1)) * 100;
            els.progressFill.style.width = `${percentage}%`;

            triggerCardAnimations(currentScreen);
            return currentScreen;
        } else {
            console.error(`Screen element .step-${num}-screen not found!`);
            return null;
        }
    }


    function createOptionCard({key, title, subtitle, description, icon, tag}) {
        return ` <div class="option-card" data-key="${key}"> <div class="option-header"> <div class="option-icon">${icon}</div> <h3 class="option-title">${title}</h3> <h4 class="option-subtitle">${subtitle}</h4> </div> <div class="option-body"> <p class="option-description">${description}</p> </div> <div class="option-footer"> <div class="option-tag">${tag}</div> <div class="option-select"><i class="fas fa-check"></i></div> </div> </div>`;
    }

    function handleOptionSelection(stepNum, options) {
        options.forEach(opt => {
            opt.addEventListener('click', function() {
                const key = this.getAttribute('data-key');
                console.log(`Step ${stepNum} option selected: ${key}`);
                userPath[`step${stepNum}`] = key;
                options.forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                const nextButton = document.getElementById(`step${stepNum}Next`);
                if (nextButton) {
                    nextButton.removeAttribute('disabled');
                } else {
                    console.warn(`Button step${stepNum}Next not found`);
                }
            });
        });
    }


    function loadOptions(stepNum, selectedKey) {
        console.log(`Loading options for step ${stepNum}, key: ${selectedKey}`);
        const container = document.getElementById(`step${stepNum}Options`);
        const nextButton = document.getElementById(`step${stepNum}Next`);

        if (!container) {
            console.error(`Container #step${stepNum}Options not found!`);
            return;
        }
        container.innerHTML = '';
        if (nextButton) nextButton.disabled = true;

        const optionsData = learningData[`step${stepNum}`]?.[selectedKey];

        if (optionsData && Array.isArray(optionsData)) {
            optionsData.forEach(opt => {
                container.innerHTML += createOptionCard(opt);
            });
            const optionCards = container.querySelectorAll('.option-card');
            handleOptionSelection(stepNum, optionCards);

            const previouslySelectedKey = userPath[`step${stepNum}`];
            if (previouslySelectedKey) {
                const cardToSelect = container.querySelector(`.option-card[data-key="${previouslySelectedKey}"]`);
                if (cardToSelect) {
                    cardToSelect.classList.add('selected');
                    if (nextButton) nextButton.disabled = false;
                }
            }
        } else {
            console.warn(`No options found for step ${stepNum} with key ${selectedKey}`);
            container.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px;">No further options available for this path.</p>';
        }
         triggerCardAnimations(container.closest('.step-screen'));
    }

    function updateRecommendation() {
        const s1Data = learningData.step1.find(i => i.key === userPath.step1);
        const s2Data = learningData.step2[userPath.step1]?.find(i => i.key === userPath.step2);
        const s3Data = learningData.step3[userPath.step2]?.find(i => i.key === userPath.step3);

        if (s1Data && s2Data && s3Data && els.recTitle && els.recDesc) {
            els.recTitle.textContent = `${s1Data.title}: ${s2Data.title} (${s3Data.title})`;
            els.recDesc.innerHTML = ` Excellent choice! Based on your selections, we recommend focusing on <strong>${s1Data.title.toLowerCase()}</strong>, specifically tailored towards <strong>${s2Data.title.toLowerCase()}</strong> with an emphasis on <strong>${s3Data.title.toLowerCase()}</strong>. Your 1-on-1 sessions will be structured to maximize progress in these areas. `;
            els.saveButton.disabled = false;
        } else {
            console.error("Could not generate recommendation text - data missing.");
            if (els.recTitle) els.recTitle.textContent = "Recommendation Unavailable";
            if (els.recDesc) els.recDesc.textContent = "We couldn't generate a recommendation based on the previous steps. Please try again.";
             if (els.saveButton) els.saveButton.disabled = true;
        }
    }

    function resetFlow() {
        userPath = {step1: null, step2: null, step3: null};
        document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
        els.step1Next?.setAttribute('disabled', true);
        els.step2Next?.setAttribute('disabled', true);
        els.step3Next?.setAttribute('disabled', true);
        els.saveButton?.setAttribute('disabled', true);
        clearFeedback();
        goToStep(1);
    }

    function triggerCardAnimations(screenElement) {
        if (!screenElement) return;
        const elementsToAnimate = screenElement.querySelectorAll('.option-card, .recommendation');
        elementsToAnimate.forEach((el, index) => {
            el.classList.remove('animate-in');
            const stagger = 0.08;
            el.style.setProperty('--card-animation-delay', `${index * stagger}s`);
            void el.offsetWidth;
            requestAnimationFrame(() => {
                el.classList.add('animate-in');
            });
        });
    }

    function goToStep(num) {
        console.log(`goToStep called for step: ${num}`);
        if (num === 2) {
            if (!userPath.step1) { console.warn("Cannot go to step 2, step 1 not selected."); return; }
            loadOptions(2, userPath.step1);
        } else if (num === 3) {
            if (!userPath.step2) { console.warn("Cannot go to step 3, step 2 not selected."); return; }
            loadOptions(3, userPath.step2);
        } else if (num === 4) {
            if (!userPath.step1 || !userPath.step2 || !userPath.step3) {
                 console.warn("Cannot go to step 4, selections incomplete:", userPath);
                 return;
            }
            updateRecommendation();
        }
        showStep(num);
    }

    // --- Save Learning Style Function ---
    async function saveLearningStyle() {
        clearFeedback();
        if (!userPath.step1 || !userPath.step2 || !userPath.step3) {
            showFeedback("Please complete all selection steps.", true);
            return;
        }

        console.log("Saving learning style:", userPath);
        showButtonLoading(els.saveButton, true);

        try {
             // Use the updated apiRequest function
            const result = await apiRequest('/api/user/preferences/learning-style', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userPath)
            });

             if (result === null) { // Redirect happened or fatal API error
                 return;
             }

            console.log("Learning style saved successfully.");
            window.location.href = "languageproficiency.html"; // Redirect on success

        } catch (error) {
            console.error("Failed to save learning style:", error);
             // Check for 401/session errors during POST as well
              if (error.message.includes('401') || error.message.includes('Not authenticated') || error.message.includes('session')) {
                   showFeedback("Your session may have expired. Please log in again.", true);
                   setTimeout(() => { window.location.href = 'welcome.html'; }, 3000);
              } else {
                   showFeedback(`Error saving preferences: ${error.message}`, true);
              }
            showButtonLoading(els.saveButton, false);
        }
    }

    // --- Header Logic Functions (Keep Existing) ---
    function updateHeaderUI(userData, hasBooking) {
        const { signInLink, userProfileHeader, userNameHeader, userAvatarHeader, notificationDot, lessonsNotificationDot } = els;
        if (userData && userProfileHeader && userNameHeader && userAvatarHeader && signInLink) {
            signInLink.style.display = 'none';
            userProfileHeader.style.display = 'flex';
            userNameHeader.textContent = userData.name || 'User';
            userAvatarHeader.src = userData.avatarUrl || 'placeholder-avatar.png';
            userAvatarHeader.onerror = () => { if (userAvatarHeader) userAvatarHeader.src = 'placeholder-avatar.png'; };
            if (notificationDot) notificationDot.style.display = hasBooking ? 'block' : 'none';
            if (lessonsNotificationDot) lessonsNotificationDot.classList.toggle('visible', hasBooking);
        } else if (signInLink && userProfileHeader) {
            signInLink.style.display = 'block';
            userProfileHeader.style.display = 'none';
            if (notificationDot) notificationDot.style.display = 'none';
            if (lessonsNotificationDot) lessonsNotificationDot.classList.remove('visible');
        }
    }

    function setupDropdown() {
        const { userProfileHeader, profileDropdown } = els;
        if (userProfileHeader && profileDropdown) {
            userProfileHeader.addEventListener('click', (event) => {
                event.stopPropagation();
                profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
            });
            window.addEventListener('click', (event) => {
                if (profileDropdown.style.display === 'block' && !userProfileHeader.contains(event.target)) {
                    profileDropdown.style.display = 'none';
                }
            });
        } else {
             console.warn("Could not set up dropdown - elements missing.");
        }
    }

    async function handleSignOut() {
        console.log("Signing out...");
        try {
            const result = await apiRequest('/api/auth/logout', { method: 'POST' });
             if (result === null) return;
            window.location.href = 'welcome.html';
        } catch (error) {
            console.error("Sign out failed:", error);
            if (error.message !== "Redirecting") {
                alert(`Sign out failed: ${error.message}`);
            }
        }
    }

    async function checkAuthAndSetupHeader() {
        console.log("[Header Auth Check] Checking...");
        try {
            const status = await apiRequest('/api/user/status', { method: 'GET' });
            if (status === null) return false; // Redirect happened

            if (status && status.user) {
                console.log("[Header Auth Check] User logged in:", status.user);
                updateHeaderUI(status.user, status.hasBooking || false);
                return true; // Auth OK
            } else {
                 console.log("[Header Auth Check] User not logged in (no status.user).");
                 updateHeaderUI(null, false);
                 console.warn("User not logged in on learning style page. Redirecting to welcome.");
                 window.location.href = 'welcome.html';
                 return false; // Auth failed
            }
        } catch (error) {
            console.warn("[Header Auth Check] Failed:", error.message);
            updateHeaderUI(null, false);
            console.error("Auth check failed, redirecting to welcome.");
            window.location.href = 'welcome.html';
            return false; // Auth failed
        }
    }

    // --- Initialize Flow and Event Listeners ---
    async function initFlow() { // Make initFlow async
        console.log("Initializing learning style flow...");

        // 1. Setup Header and check auth status FIRST
        const isAuthOk = await checkAuthAndSetupHeader(); // Wait for auth check (might redirect)
        setupDropdown(); // Setup dropdown interactivity
        if(els.signOutBtn) {
            els.signOutBtn.addEventListener('click', handleSignOut); // Setup signout listener
        }

        // 2. Check if auth check failed (redirected), stop further setup
         if (!isAuthOk) {
             console.log("Halting flow initialization as user is not logged in or redirected.");
             return; // Stop further initialization
         }

        // 3. Check for existing learning style preferences (only if authenticated)
        await checkExistingPreferences();

        // 4. Setup learning style step listeners (safe to add even if skipped)
        const step1Cards = document.querySelectorAll('.step-1-screen .option-card');
        handleOptionSelection(1, step1Cards);

        // Navigation button listeners
        els.step1Next?.addEventListener('click', () => goToStep(2));
        els.step2Back?.addEventListener('click', () => goToStep(1));
        els.step2Next?.addEventListener('click', () => goToStep(3));
        els.step3Back?.addEventListener('click', () => goToStep(2));
        els.step3Next?.addEventListener('click', () => goToStep(4));
        els.step4Back?.addEventListener('click', resetFlow);
        els.saveButton?.addEventListener('click', saveLearningStyle);

        // Initial animation trigger
        const activeScreen = document.querySelector('.step-screen.active');
        if (activeScreen) {
            triggerCardAnimations(activeScreen);
        }

        console.log("Flow initialized, event listeners added.");
    }


    // --- DOMContentLoaded Setup ---
    window.addEventListener('DOMContentLoaded', function() {
        initFlow(); // Start the process, now including header setup

        // Scroll listener for header style change (keep existing)
        window.addEventListener('scroll', function() {
            document.body.classList.toggle('scrolled', window.scrollY > 30);
        }, { passive: true });
    });

  </script>
</body>
</html>